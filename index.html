<!DOCTYPE html>
<html lang="es">
<body>
  <main>
    <!-- Panel de control principal -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-sliders-h"></i>
        Filtros de Análisis
      </div>
      
      <!-- Controles simplificados -->
      <div class="controls" id="controls">
        <div class="control-group">
          <label for="selectLugar"><i class="fas fa-map-marker-alt"></i> Ubicación</label>
          <select id="selectLugar">
            <option value="">Todas las ubicaciones</option>
          </select>
          <div class="filter-info" id="lugarInfo">Cargando...</div>
        </div>
      </div>

      <div class="action-buttons">
        <button id="btnResetFilters" class="secondary">
          <i class="fas fa-undo"></i> Restablecer Filtros
        </button>
      </div>
    </div>

    <!-- Tarjetas de resumen actualizado -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-chart-line"></i>
        Resumen General
      </div>
      
      <div class="summary-cards" id="summaryCards">
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-clipboard-list"></i> Total de Encuestas
          </div>
          <div class="summary-value" id="summaryEncuestas">0</div>
          <div class="summary-subtitle">
            <span>Registros en la base de datos</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-map-marked-alt"></i> Total de Ubicaciones
          </div>
          <div class="summary-value" id="summaryUbicaciones">0</div>
          <div class="summary-subtitle">
            <span>Lugares únicos registrados</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-weight-hanging"></i> Total de Desechos
          </div>
          <div class="summary-value" id="summaryTotalKg">0 kg</div>
          <div class="summary-subtitle">
            <span>Suma total de kilogramos</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-title">
            <i class="fas fa-balance-scale"></i> Promedio por Encuesta
          </div>
          <div class="summary-value" id="summaryPromedio">0 kg</div>
          <div class="summary-subtitle">
            <span>Promedio de kg por encuesta</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráficos y visualizaciones -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-chart-bar"></i>
        Visualización de Datos
      </div>
      
      <!-- Botones de tipo de gráfico mejorados -->
      <div class="chart-actions">
        <div class="chart-action-btn active" data-chart-type="bar">
          <i class="fas fa-chart-bar"></i> Barras
        </div>
        <div class="chart-action-btn" data-chart-type="pie">
          <i class="fas fa-chart-pie"></i> Torta
        </div>
        <div class="chart-action-btn" data-chart-type="line">
          <i class="fas fa-chart-line"></i> Líneas
        </div>
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="main-chart">Distribución por Categoría</div>
      </div>
      
      <div class="tab-content active" id="main-chart">
        <div class="chart-container">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabla resumen con categorías y subcategorías -->
    <div class="card">
      <div class="card-title">
        <i class="fas fa-table"></i>
        Tabla Resumen por Categorías
      </div>
      
      <div class="table-responsive">
        <table id="tableResumen">
          <thead>
            <tr>
              <th>Categoría / Subcategoría</th>
              <th style="text-align:right">Peso (kg)</th>
              <th style="text-align:right">% del Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
  (async function(){
    // ---------- CONFIGURACIÓN ----------
    const SUPABASE_URL = "https://dutapywxsiuxboqsjqvf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ---------- SELECTORES ----------
    const selectLugar = document.getElementById('selectLugar');
    const btnResetFilters = document.getElementById('btnResetFilters');

    // Elementos de información de filtros
    const lugarInfo = document.getElementById('lugarInfo');

    // Elementos de resumen
    const summaryEncuestas = document.getElementById('summaryEncuestas');
    const summaryUbicaciones = document.getElementById('summaryUbicaciones');
    const summaryTotalKg = document.getElementById('summaryTotalKg');
    const summaryPromedio = document.getElementById('summaryPromedio');
    
    // Tabla
    const tbody = document.querySelector('#tableResumen tbody');

    // Charts
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    let mainChart;

    // Variables globales para datos
    let currentData = [];
    let allData = [];
    let currentChartType = 'bar';
    let filterOptions = {
      lugares: []
    };

    // Definición de las 15 categorías principales con sus subcategorías (basado en la estructura real de la BD)
    const categoriasPrincipales = [
      {
        id: 1,
        nombre: "MATERIA ORGÁNICA",
        subcategorias: [
          { campo: "materia_organica_jardin_kg", nombre: "De jardín" },
          { campo: "materia_organica_cocina_kg", nombre: "De cocina" }
        ]
      },
      {
        id: 2,
        nombre: "GRASAS Y ACEITES",
        subcategorias: [
          { campo: "grasas_aceite_comestible_kg", nombre: "Aceite comestible" }
        ]
      },
      {
        id: 3,
        nombre: "MEDICINA",
        subcategorias: [
          { campo: "medicina_jarabe_kg", nombre: "Jarabe" },
          { campo: "medicina_tabletas_kg", nombre: "Tabletas" }
        ]
      },
      {
        id: 4,
        nombre: "PAPELES Y CARTÓN",
        subcategorias: [
          { campo: "papel_blanco_kg", nombre: "Papel blanco" },
          { campo: "papel_periodico_kg", nombre: "Papel periódico" },
          { campo: "papel_archivo_kg", nombre: "Papel archivo" },
          { campo: "carton_kg", nombre: "Cartón" },
          { campo: "tetra_brik_kg", nombre: "Tetra-brik" }
        ]
      },
      {
        id: 5,
        nombre: "PLÁSTICOS",
        subcategorias: [
          { campo: "plastico_pet_kg", nombre: "PET" },
          { campo: "plastico_mixto_kg", nombre: "Plástico mixto" },
          { campo: "bot_aceite_kg", nombre: "Botella de aceite" },
          { campo: "bolsas_kg", nombre: "Bolsas" }
        ]
      },
      {
        id: 6,
        nombre: "VIDRIOS",
        subcategorias: [
          { campo: "vidrio_blanco_kg", nombre: "Blanco" },
          { campo: "vidrio_verde_kg", nombre: "Verde" },
          { campo: "vidrio_otros_kg", nombre: "Otros" }
        ]
      },
      {
        id: 7,
        nombre: "METAL",
        subcategorias: [
          { campo: "latas_ferrosas_kg", nombre: "Latas ferrosas" },
          { campo: "aluminio_kg", nombre: "Aluminio" },
          { campo: "acero_kg", nombre: "Acero" },
          { campo: "metal_otros_kg", nombre: "Otros" }
        ]
      },
      {
        id: 8,
        nombre: "TEXTILES",
        subcategorias: [
          { campo: "textiles_ropa_kg", nombre: "Ropa, mantas, manteles, etc." }
        ]
      },
      {
        id: 9,
        nombre: "CAUCHO",
        subcategorias: [
          { campo: "caucho_zapatos_neumaticos_kg", nombre: "Zapatos, neumáticos" }
        ]
      },
      {
        id: 10,
        nombre: "CUERO",
        subcategorias: [
          { campo: "cuero_zapatos_neumaticos_kg", nombre: "Zapatos, carteras, etc." }
        ]
      },
      {
        id: 11,
        nombre: "RESIDUOS SANITARIOS",
        subcategorias: [
          { campo: "papel_higienico_kg", nombre: "Papel higiénico" }
        ]
      },
      {
        id: 12,
        nombre: "MADERAS",
        subcategorias: [
          { campo: "maderas_kg", nombre: "Maderas" }
        ]
      },
      {
        id: 13,
        nombre: "BATERÍAS",
        subcategorias: [
          { campo: "baterias_tel_lamparas_kg", nombre: "De teléfono, lámparas" }
        ]
      },
      {
        id: 14,
        nombre: "EQUIPOS ELECTRÓNICOS",
        subcategorias: [
          { campo: "electronicos_electrodomesticos_kg", nombre: "Electrodomésticos" }
        ]
      },
      {
        id: 15,
        nombre: "ESCOMBROS",
        subcategorias: [
          { campo: "escombros_otros_kg", nombre: "Otros" }
        ]
      }
    ];

    // Mapeo de nombres abreviados para gráficos (para evitar truncamiento)
    const nombresCortos = {
      "MATERIA ORGÁNICA": "Materia Orgánica",
      "GRASAS Y ACEITES": "Grasas/Aceites",
      "MEDICINA": "Medicina",
      "PAPELES Y CARTÓN": "Papel/Cartón",
      "PLÁSTICOS": "Plásticos",
      "VIDRIOS": "Vidrios",
      "METAL": "Metal",
      "TEXTILES": "Textiles",
      "CAUCHO": "Caucho",
      "CUERO": "Cuero",
      "RESIDUOS SANITARIOS": "Residuos Sanitarios",
      "MADERAS": "Maderas",
      "BATERÍAS": "Baterías",
      "EQUIPOS ELECTRÓNICOS": "Equipos Electrónicos",
      "ESCOMBROS": "Escombros"
    };

    // Función para calcular intervalos dinámicos según el valor máximo
    function calcularIntervaloDinamico(maxValue) {
      // Si el valor máximo es 0, usar valores por defecto
      if (maxValue === 0) return { max: 10, stepSize: 2 };
      
      // Calcular el valor máximo para el eje Y (con margen adicional)
      let yAxisMax;
      
      // Diferentes estrategias según el rango de valores
      if (maxValue < 5) {
        // Para valores muy pequeños (0-5 kg)
        yAxisMax = Math.ceil(maxValue * 1.5); // 50% más
      } else if (maxValue < 20) {
        // Para valores pequeños (5-20 kg)
        yAxisMax = Math.ceil(maxValue * 1.3); // 30% más
      } else if (maxValue < 100) {
        // Para valores medianos (20-100 kg)
        yAxisMax = Math.ceil(maxValue * 1.2); // 20% más
      } else if (maxValue < 500) {
        // Para valores grandes (100-500 kg)
        yAxisMax = Math.ceil(maxValue * 1.15); // 15% más
      } else {
        // Para valores muy grandes (>500 kg)
        yAxisMax = Math.ceil(maxValue * 1.1); // 10% más
      }
      
      // Redondear a un número "bonito" (múltiplo de 5, 10, 50, 100, etc.)
      const rangos = [1, 2, 5, 10, 20, 50, 100, 200, 500, 1000, 2000, 5000];
      let intervalo = 1;
      
      for (let i = 0; i < rangos.length; i++) {
        if (yAxisMax / rangos[i] <= 15) { // No más de 15 intervalos
          intervalo = rangos[i];
          break;
        }
      }
      
      // Ajustar yAxisMax para que sea múltiplo del intervalo
      yAxisMax = Math.ceil(yAxisMax / intervalo) * intervalo;
      
      // Asegurar que yAxisMax sea al menos un poco mayor que maxValue
      if (yAxisMax <= maxValue) {
        yAxisMax = maxValue + intervalo;
      }
      
      // Calcular stepSize basado en el intervalo
      const stepSize = intervalo;
      
      return { max: yAxisMax, stepSize: stepSize };
    }

    // Inicializar la aplicación
    async function initApp() {
      await cargarTodosLosDatos();
      await inicializarFiltros();
      await actualizar();
      setupEventListeners();
    }

    // Configurar event listeners
    function setupEventListeners() {
      // Actualización automática al cambiar filtros
      selectLugar.addEventListener('change', async function() {
        await actualizar();
      });
      
      // Botones de tipo de gráfico - versión mejorada
      document.querySelectorAll('.chart-action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Remover clase activa de todos los botones
          document.querySelectorAll('.chart-action-btn').forEach(b => {
            b.classList.remove('active');
          });
          
          // Agregar clase activa al botón seleccionado
          this.classList.add('active');
          
          // Cambiar tipo de gráfico
          currentChartType = this.getAttribute('data-chart-type');
          
          // Re-renderizar el gráfico
          if (currentData.length > 0) {
            const resumenCategorias = calcularResumenPorCategorias(currentData);
            renderChart(resumenCategorias.categorias, resumenCategorias.valores, currentChartType);
          }
        });
      });
      
      // Botón para restablecer filtros
      btnResetFilters.addEventListener('click', function() {
        selectLugar.value = '';
        actualizar();
      });
    }

    // Cargar todos los datos para análisis comparativos
    async function cargarTodosLosDatos() {
      const q = await supabase.from('caracterizacion_desechos_daule').select('*');
      if (q.error) {
        console.error(q.error);
        return;
      }
      allData = q.data || [];
    }

    // Cargar lista de filtros desde la BD
    async function inicializarFiltros() {
      // Obtener todos los datos para construir los filtros
      const q = await supabase.from('caracterizacion_desechos_daule').select('lugar');
      if (q.error) {
        console.error(q.error);
        return;
      }
      const rows = q.data || [];

      // Construir opciones de filtro
      filterOptions.lugares = [...new Set(rows.map(r => r.lugar).filter(Boolean))].sort();

      // Actualizar información de filtros
      lugarInfo.textContent = `${filterOptions.lugares.length} ubicaciones disponibles`;

      // Llenar selectores con todas las opciones iniciales
      llenarSelector(selectLugar, filterOptions.lugares);
    }

    // Función para llenar un selector con opciones
    function llenarSelector(selector, opciones) {
      // Guardar la opción seleccionada actualmente
      const valorActual = selector.value;
      
      // Limpiar selector (excepto la primera opción)
      while (selector.options.length > 1) {
        selector.remove(1);
      }
      
      // Agregar nuevas opciones
      opciones.forEach(opcion => {
        const option = document.createElement('option');
        option.value = opcion;
        option.textContent = opcion;
        selector.appendChild(option);
      });
      
      // Restaurar la selección anterior si todavía existe
      if (valorActual && opciones.includes(valorActual)) {
        selector.value = valorActual;
      }
    }

    // Construir query según filtros y traer datos
    async function obtenerFiltrados() {
      let q = supabase.from('caracterizacion_desechos_daule').select('*');
      if (selectLugar.value) q = q.eq('lugar', selectLugar.value);
      
      const r = await q;
      if (r.error) {
        console.error(r.error);
        return [];
      }
      return r.data || [];
    }

    // Calcular resumen por las 15 categorías principales
    function calcularResumenPorCategorias(rows) {
      if (!rows || rows.length === 0) {
        return {
          categorias: [],
          valores: [],
          totalSum: 0,
          detalles: []
        };
      }
      
      const valoresPorCategoria = Array(categoriasPrincipales.length).fill(0);
      const detallesPorCategoria = [];
      
      // Calcular totales por categoría
      rows.forEach(row => {
        categoriasPrincipales.forEach((categoria, idx) => {
          categoria.subcategorias.forEach(subcategoria => {
            const valor = parseFloat(row[subcategoria.campo]) || 0;
            valoresPorCategoria[idx] += valor;
          });
        });
      });
      
      // Preparar detalles para la tabla
      categoriasPrincipales.forEach((categoria, idx) => {
        const totalCategoria = valoresPorCategoria[idx];
        
        // Calcular subtotales por subcategoría
        const subcategoriasConValores = categoria.subcategorias.map(subcategoria => {
          let subtotal = 0;
          rows.forEach(row => {
            subtotal += parseFloat(row[subcategoria.campo]) || 0;
          });
          return {
            nombre: subcategoria.nombre,
            valor: subtotal
          };
        }).filter(sub => sub.valor > 0);
        
        if (totalCategoria > 0 || subcategoriasConValores.length > 0) {
          detallesPorCategoria.push({
            categoria: categoria.nombre,
            total: totalCategoria,
            subcategorias: subcategoriasConValores
          });
        }
      });
      
      const totalSum = valoresPorCategoria.reduce((a, b) => a + b, 0);
      
      // Filtrar categorías con valores > 0 y usar nombres cortos para gráficos
      const categoriasConValores = [];
      const valoresFiltrados = [];
      
      detallesPorCategoria.forEach((detalle, idx) => {
        if (detalle.total > 0) {
          // Usar nombres cortos para gráficos, nombres completos para tabla
          categoriasConValores.push(nombresCortos[detalle.categoria] || detalle.categoria);
          valoresFiltrados.push(detalle.total);
        }
      });
      
      return {
        categorias: categoriasConValores,
        valores: valoresFiltrados,
        totalSum: totalSum,
        detalles: detallesPorCategoria
      };
    }

    // Renderizar gráfico principal con tipo seleccionado - INTERVALO DINÁMICO
    function renderChart(labels, values, chartType) {
      if (mainChart) mainChart.destroy();
      
      // Calcular porcentajes para mostrar en los gráficos
      const totalSum = values.reduce((a, b) => a + b, 0);
      const percentages = values.map(v => totalSum > 0 ? ((v / totalSum) * 100) : 0);
      const percentageLabels = percentages.map(p => p.toFixed(1) + '%');
      
      // Calcular el valor máximo
      const maxValue = Math.max(...values);
      
      // Calcular intervalo dinámico según el valor máximo
      const { max: yAxisMax, stepSize } = calcularIntervaloDinamico(maxValue);
      
      // Colores más atractivos y consistentes
      const colors = [
        '#4f46e5', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
        '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#a855f7', '#6366f1',
        '#14b8a6', '#f43f5e', '#8b5cf6'
      ].slice(0, labels.length);
      
      // Configuración base para todos los gráficos
      const baseConfig = {
        data: {
          labels: labels,
          datasets: [{
            label: 'Peso (kg)',
            data: values,
            backgroundColor: chartType === 'line' ? '#0f766e' : colors,
            borderColor: chartType === 'line' ? '#0f766e' : colors.map(c => c.replace(')', ', 0.8)')),
            borderWidth: chartType === 'line' ? 3 : 1,
            pointBackgroundColor: colors,
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: chartType === 'line' ? 6 : 0,
            pointHoverRadius: chartType === 'line' ? 8 : 0,
            fill: chartType === 'line' ? {
              target: 'origin',
              above: 'rgba(15, 118, 110, 0.1)'
            } : undefined,
            tension: chartType === 'line' ? 0.4 : 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: chartType === 'pie',
              position: 'right',
              labels: {
                font: {
                  size: 11
                },
                // Mostrar porcentajes en la leyenda del gráfico circular
                generateLabels: function(chart) {
                  if (chartType === 'pie') {
                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                    const labels = original.call(this, chart);
                    // Agregar porcentaje a cada etiqueta
                    labels.forEach((label, i) => {
                      label.text += ` (${percentageLabels[i]})`;
                    });
                    return labels;
                  }
                  return Chart.defaults.plugins.legend.labels.generateLabels.call(this, chart);
                }
              }
            },
            title: {
              display: true,
              text: `Distribución de Desechos Sólidos por Categoría - ${getChartTypeName(chartType)}`,
              font: {
                size: 16,
                weight: 'bold'
              },
              padding: 20
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) label += ': ';
                  const value = context.parsed !== undefined ? context.parsed : context.raw;
                  label += value.toFixed(2) + ' kg';
                  // Agregar porcentaje al tooltip
                  const percentage = totalSum > 0 ? (value / totalSum * 100).toFixed(1) : 0;
                  label += ` (${percentage}%)`;
                  return label;
                }
              }
            }
          }
        }
      };
      
      // CONFIGURACIÓN ESPECÍFICA PARA CADA TIPO DE GRÁFICO CON INTERVALO DINÁMICO
      const typeSpecificConfigs = {
        bar: {
          scales: {
            y: {
              beginAtZero: true,
              max: yAxisMax, // Límite dinámico del eje Y
              title: {
                display: true,
                text: 'Peso (kg)',
                font: { size: 14, weight: 'bold' },
                padding: { top: 20, bottom: 10 }
              },
              ticks: {
                callback: function(value) {
                  // Quitar el .0 y mostrar solo números enteros
                  return Number.isInteger(value) ? value.toString() : value.toFixed(1);
                },
                padding: 20,
                stepSize: stepSize, // Intervalo dinámico
                maxTicksLimit: 15,
                font: {
                  size: 12
                }
              },
              grid: {
                drawBorder: false
              }
            },
            x: {
              title: {
                display: true,
                text: 'Categorías de Desechos',
                font: { size: 14, weight: 'bold' },
                padding: { top: 10, bottom: 20 }
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                padding: 10,
                font: {
                  size: 11
                },
                autoSkip: true,
                maxTicksLimit: 15
              },
              grid: {
                display: false
              }
            }
          },
          barPercentage: 0.7,
          categoryPercentage: 0.8,
          plugins: {
            datalabels: {
              display: true,
              color: '#1e293b',
              font: {
                weight: 'bold',
                size: 12
              },
              formatter: function(value, context) {
                return percentageLabels[context.dataIndex];
              },
              anchor: 'end',
              align: 'top',
              offset: 15,
              clamp: true
            }
          }
        },
        line: {
          scales: {
            y: {
              beginAtZero: true,
              max: yAxisMax, // Límite dinámico del eje Y
              title: {
                display: true,
                text: 'Peso (kg)',
                font: { size: 14, weight: 'bold' },
                padding: { top: 20, bottom: 10 }
              },
              ticks: {
                callback: function(value) {
                  // Quitar el .0 y mostrar solo números enteros
                  return Number.isInteger(value) ? value.toString() : value.toFixed(1);
                },
                padding: 20,
                stepSize: stepSize, // Intervalo dinámico
                maxTicksLimit: 15,
                font: {
                  size: 12
                }
              },
              grid: {
                drawBorder: false
              }
            },
            x: {
              title: {
                display: true,
                text: 'Categorías de Desechos',
                font: { size: 14, weight: 'bold' },
                padding: { top: 10, bottom: 20 }
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                padding: 10,
                font: {
                  size: 11
                },
                autoSkip: true,
                maxTicksLimit: 15
              },
              grid: {
                display: false
              }
            }
          },
          plugins: {
            datalabels: {
              display: true,
              color: '#1e293b',
              font: {
                weight: 'bold',
                size: 12
              },
              formatter: function(value, context) {
                return percentageLabels[context.dataIndex];
              },
              anchor: 'center',
              align: 'top',
              offset: 20,
              clamp: true
            }
          }
        },
        pie: {
          // Configuración para gráfico circular con porcentajes DENTRO
          elements: {
            arc: {
              borderWidth: 1.5,
              borderColor: '#ffffff',
              hoverBorderWidth: 2.5,
              hoverBorderColor: '#ffffff'
            }
          },
          plugins: {
            datalabels: {
              display: true,
              color: function(context) {
                // Colores contrastantes para mejor legibilidad
                const backgroundColor = context.dataset.backgroundColor[context.dataIndex];
                const rgb = hexToRgb(backgroundColor);
                const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
                return brightness > 128 ? '#1e293b' : '#ffffff';
              },
              font: {
                weight: 'bold',
                size: 12
              },
              formatter: function(value, context) {
                // Mostrar porcentaje dentro del segmento
                const percentage = percentages[context.dataIndex];
                // Solo mostrar si el segmento es lo suficientemente grande
                if (percentage > 3) {
                  return percentageLabels[context.dataIndex];
                }
                return ''; // Ocultar en segmentos muy pequeños
              },
              anchor: 'center',
              align: 'center',
              offset: 0,
              textAlign: 'center',
              textShadow: true,
              shadowBlur: 3,
              shadowColor: 'rgba(0,0,0,0.5)',
              clamp: false
            }
          }
        }
      };
      
      // Ajustes de layout específicos
      const layoutConfigs = {
        bar: {
          padding: {
            top: 50,
            bottom: 70,
            left: 30,
            right: 30
          }
        },
        line: {
          padding: {
            top: 50,
            bottom: 70,
            left: 30,
            right: 30
          }
        },
        pie: {
          padding: {
            top: 20,
            bottom: 20,
            left: 10,
            right: 10
          }
        }
      };
      
      // Combinar configuración base con configuración específica del tipo
      const finalConfig = {
        type: chartType,
        data: baseConfig.data,
        options: {
          ...baseConfig.options,
          ...(typeSpecificConfigs[chartType] || {}),
          layout: layoutConfigs[chartType] || {
            padding: {
              top: 40,
              bottom: 50,
              left: 20,
              right: 20
            }
          }
        },
        plugins: [ChartDataLabels]
      };
      
      mainChart = new Chart(mainCtx, finalConfig);
    }
    
    // Función auxiliar para convertir HEX a RGB
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : { r: 0, g: 0, b: 0 };
    }
    
    // Obtener nombre legible del tipo de gráfico
    function getChartTypeName(type) {
      const names = {
        'bar': 'Gráfico de Barras',
        'pie': 'Gráfico Circular',
        'line': 'Gráfico de Líneas'
      };
      return names[type] || type;
    }

    // Rellenar tabla resumen y actualizar resúmenes
    function renderResumen(currentSummary) {
      tbody.innerHTML = '';
      
      // Actualizar resumen de encuestas y ubicaciones
      summaryEncuestas.textContent = currentData.length;
      
      // Calcular ubicaciones únicas
      const ubicacionesUnicas = [...new Set(currentData.map(r => r.lugar).filter(Boolean))];
      summaryUbicaciones.textContent = ubicacionesUnicas.length;
      
      // Actualizar total de kg
      summaryTotalKg.textContent = currentSummary.totalSum.toFixed(2) + ' kg';
      
      // Calcular promedio por encuesta (total de kg / número de encuestas)
      const promedioPorEncuesta = currentData.length > 0 ? currentSummary.totalSum / currentData.length : 0;
      summaryPromedio.textContent = promedioPorEncuesta.toFixed(2) + ' kg';
      
      // Llenar tabla con categorías y subcategorías
      let totalGeneral = 0;
      let esPrimeraCategoria = true;
      
      currentSummary.detalles.forEach((detalle, index) => {
        if (detalle.total > 0) {
          // Si no es la primera categoría, agregar una fila separadora
          if (!esPrimeraCategoria) {
            const separador = document.createElement('tr');
            separador.className = 'separator-row';
            separador.innerHTML = `<td colspan="3"></td>`;
            tbody.appendChild(separador);
          }
          
          // Fila de categoría principal
          const trCategoria = document.createElement('tr');
          trCategoria.className = 'category-header';
          trCategoria.innerHTML = `
            <td><strong>${detalle.categoria}</strong></td>
            <td style="text-align:right"></td>
            <td style="text-align:right"></td>
          `;
          tbody.appendChild(trCategoria);
          
          totalGeneral += detalle.total;
          
          // Filas de subcategorías
          detalle.subcategorias.forEach(subcategoria => {
            const porcentajeSubcategoria = currentSummary.totalSum > 0 ? 
              ((subcategoria.valor / currentSummary.totalSum) * 100).toFixed(2) + '%' : '0.00%';
            
            const trSubcategoria = document.createElement('tr');
            trSubcategoria.className = 'subcategory-row';
            trSubcategoria.innerHTML = `
              <td>${subcategoria.nombre}</td>
              <td style="text-align:right">${subcategoria.valor.toFixed(2)}</td>
              <td style="text-align:right">${porcentajeSubcategoria}</td>
            `;
            tbody.appendChild(trSubcategoria);
          });
          
          // Fila de TOTAL de la categoría
          const porcentajeCategoria = currentSummary.totalSum > 0 ? 
            ((detalle.total / currentSummary.totalSum) * 100).toFixed(2) + '%' : '0.00%';
          
          const trTotalCategoria = document.createElement('tr');
          trTotalCategoria.className = 'category-total-row';
          trTotalCategoria.innerHTML = `
            <td><strong>TOTAL ${detalle.categoria}</strong></td>
            <td style="text-align:right"><strong>${detalle.total.toFixed(2)}</strong></td>
            <td style="text-align:right"><strong>${porcentajeCategoria}</strong></td>
          `;
          tbody.appendChild(trTotalCategoria);
          
          esPrimeraCategoria = false;
        }
      });
      
      // Si no hay datos, mostrar mensaje
      if (currentSummary.detalles.length === 0) {
        const trVacio = document.createElement('tr');
        trVacio.innerHTML = `
          <td colspan="3" style="text-align:center; padding:40px; color:var(--muted);">
            No hay datos disponibles para los filtros seleccionados
          </td>
        `;
        tbody.appendChild(trVacio);
      } else {
        // Agregar fila de total general al final de la tabla
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
          <td><strong>TOTAL GENERAL</strong></td>
          <td style="text-align:right"><strong>${totalGeneral.toFixed(2)}</strong></td>
          <td style="text-align:right"><strong>100.00%</strong></td>
        `;
        tbody.appendChild(totalRow);
      }
    }

    // Acción principal: obtener datos, procesar y renderizar
    async function actualizar() {
      try {
        // Obtener datos del período actual
        currentData = await obtenerFiltrados();
        
        // Procesar datos por categorías
        const currentSummary = calcularResumenPorCategorias(currentData);
        
        // Renderizar gráfico y tabla
        renderChart(currentSummary.categorias, currentSummary.valores, currentChartType);
        renderResumen(currentSummary);
        
      } catch (err) {
        console.error(err);
        alert('Error al actualizar. Revisa la consola para más detalles.');
      }
    }

    // Inicialización
    await initApp();

  })();
  </script>
</body>
</html>
