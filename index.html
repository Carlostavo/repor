<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Sistema de Gestión de Residuos Sólidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Variables de diseño optimizadas para estilos más claros y suaves */
    :root {
      --primary-color: #2e8b57; /* Verde más suave */
      --primary-dark: #1e6b47;
      --secondary-color: #4a6572; /* Gris azulado más suave */
      --accent-color: #5d9cec; /* Azul más suave */
      --light-color: #f9fbfd; /* Fondo más claro */
      --dark-color: #3a3a3a; /* Texto más suave */
      --success-color: #4caf50;
      --warning-color: #ffb74d;
      --danger-color: #e57373;
      --info-color: #4fc3f7;
      --border-radius: 10px; /* Bordes más suaves */
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Sombras más suaves */
      --transition: all 0.25s ease;
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --safe-area-inset-left: env(safe-area-inset-left);
      --safe-area-inset-right: env(safe-area-inset-right);
    }
    
    /* Reset mejorado para compatibilidad entre navegadores */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Estilos Generales optimizados con colores más claros */
    body { 
      background-color: var(--light-color); 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: var(--dark-color);
      padding-top: constant(safe-area-inset-top);
      padding-top: env(safe-area-inset-top);
      padding-bottom: constant(safe-area-inset-bottom);
      padding-bottom: env(safe-area-inset-bottom);
      margin: 0;
      padding: 0;
    }
    
    /* Navbar mejorada con colores más suaves */
    .navbar {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 0.8rem 1rem;
      padding-top: calc(0.8rem + constant(safe-area-inset-top));
      padding-top: calc(0.8rem + env(safe-area-inset-top));
      padding-left: calc(1rem + constant(safe-area-inset-left));
      padding-left: calc(1rem + env(safe-area-inset-left));
      padding-right: calc(1rem + constant(safe-area-inset-right));
      padding-right: calc(1rem + env(safe-area-inset-right));
    }
    
    .navbar-brand-custom { 
      font-size: clamp(1.2rem, 4vw, 1.5rem);
      font-weight: 700;
      color: white !important;
      display: flex;
      align-items: center;
    }
    
    .navbar-brand-custom i {
      font-size: clamp(1.5rem, 4vw, 1.8rem);
      margin-right: 10px;
    }
    
    .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.9) !important;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin: 0 2px;
      transition: var(--transition);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
    }
    
    .navbar-nav .nav-link:hover, 
    .navbar-nav .nav-link:focus {
      background-color: rgba(255, 255, 255, 0.15);
      color: white !important;
    }
    
    .nav-link.restricted-nav {
      color: rgba(255, 255, 255, 0.6) !important;
      cursor: pointer;
    }
    
    .nav-link.restricted-nav:hover {
      color: rgba(255, 255, 255, 0.8) !important; 
    }
    
    .navbar-toggler {
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.25rem 0.5rem;
    }
    
    .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.8%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      width: 1.2em;
      height: 1.2em;
    }

    /* Panel Lateral mejorado con fondo más claro */
    #editSidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: min(300px, 85vw);
      padding-top: calc(70px + constant(safe-area-inset-top));
      padding-top: calc(70px + env(safe-area-inset-top));
      z-index: 1040;
      border-right: 1px solid #e9ecef;
      overflow-y: auto;
      background: #f8fafc; /* Fondo más claro */
      transition: all 0.3s ease;
      font-size: 0.9rem;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.03); /* Sombra más suave */
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    .sidebar-section { 
      padding: 15px 0; 
      border-bottom: 1px solid #e9ecef; 
    }
    
    .sidebar-section:last-child { 
      border-bottom: none; 
    }
    
    .sidebar-heading { 
      color: var(--secondary-color); 
      font-size: 0.95rem; 
      margin-bottom: 0.75rem; 
      display: flex; 
      align-items: center; 
      font-weight: 600;
    }
    
    .sidebar-heading i { 
      margin-right: 10px; 
      color: var(--primary-color);
    }

    /* Contenedor Principal optimizado */
    .d-none-temp { 
      display: none !important; 
    }
    
    .section-content { 
      display: none; 
      padding-top: 20px; 
      animation: fadeIn 0.5s ease;
      position: relative;
      min-height: 100px; /* Reducido para permitir ajuste automático */
    } 
    
    #section-inicio { 
      display: block; 
      padding-top: 0; 
    }
    
    #mainContentWrapper { 
      transition: margin-left .3s ease; 
      padding-left: constant(safe-area-inset-left);
      padding-left: env(safe-area-inset-left);
      padding-right: constant(safe-area-inset-right);
      padding-right: env(safe-area-inset-right);
    }
    
    #mainContent {
      position: relative;
      max-width: 1400px;
      padding-bottom: 20px;
      min-height: auto; /* Permitir ajuste automático */
    }
    
    /* Hero Section con colores más suaves */
    .hero-section {
      background: linear-gradient(135deg, var(--secondary-color) 0%, #5a7686 100%); /* Gradiente más suave */
      color: white;
      padding: clamp(30px, 8vw, 60px) clamp(15px, 4vw, 30px);
      border-radius: var(--border-radius);
      margin-bottom: clamp(20px, 6vw, 40px);
      text-align: center;
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
      margin-left: constant(safe-area-inset-left);
      margin-left: env(safe-area-inset-left);
      margin-right: constant(safe-area-inset-right);
      margin-right: env(safe-area-inset-right);
    }
    
    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.05)"/></svg>');
      background-size: cover;
    }
    
    .hero-title {
      font-size: clamp(1.8rem, 6vw, 2.8rem);
      font-weight: 700; /* Peso de fuente más suave */
      margin-bottom: clamp(15px, 4vw, 20px);
      position: relative;
      line-height: 1.2;
    }
    
    .hero-subtitle {
      font-size: clamp(1rem, 3vw, 1.3rem);
      max-width: min(900px, 90vw);
      margin: 0 auto;
      line-height: 1.7;
      opacity: 0.9;
      font-weight: 400;
    }

    /* Cards optimizadas con estilos más suaves */
    .card {
      height: 100%;
      transition: var(--transition);
      border: none;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06); /* Sombra más suave */
      cursor: pointer; 
      position: relative;
      overflow: hidden;
      background: white;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    .card:hover {
      transform: translateY(-5px); /* Elevación más suave */
      box-shadow: 0 8px 20px rgba(0,0,0,0.08); /* Sombra más suave */
    }
    
    /* Mejora para dispositivos táctiles */
    @media (hover: none) and (pointer: coarse) {
      .card:hover {
        transform: none;
      }
      
      .card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
      }
    }
    
    .card-body {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: var(--dark-color) !important;
      padding: clamp(1.25rem, 4vw, 2rem);
      position: relative;
      z-index: 2;
    }
    
    .card-title { 
      font-weight: 600; /* Peso de fuente más suave */
      font-size: clamp(1.1rem, 3vw, 1.3rem);
      margin-bottom: clamp(0.75rem, 2vw, 1rem);
      position: relative;
      line-height: 1.3;
    }
    
    .card-title::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 40px;
      height: 2px; /* Línea más delgada */
      background: var(--primary-color);
      border-radius: 2px;
    }
    
    .card-text { 
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      opacity: 0.8; 
      line-height: 1.6;
    }
    
    .card-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: clamp(2rem, 5vw, 2.5rem);
      opacity: 0.08; /* Icono más sutil */
      z-index: 1;
    }

    /* Cards con fondo oscuro */
    .card.text-white .card-body { 
      color: white !important; 
    }
    
    .card.text-white .card-text { 
      opacity: 0.9; 
    }
    
    .card.text-white .card-title::after {
      background: white;
    }

    /* Estilo para tarjetas restringidas */
    .card.restricted {
      filter: grayscale(0.5) brightness(0.95); /* Efecto más suave */
      position: relative;
      overflow: hidden;
    }
    
    .card.restricted::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.2); /* Overlay más suave */
      z-index: 1;
    }
    
    .card.restricted .card-body {
      position: relative;
      z-index: 2;
    }
    
    .card.restricted .restricted-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.6); /* Overlay más suave */
      color: white;
      z-index: 3;
      opacity: 0;
      transition: var(--transition);
      border-radius: var(--border-radius);
      padding: clamp(1rem, 3vw, 2rem);
      text-align: center;
    }
    
    .card.restricted:hover .restricted-overlay {
      opacity: 1;
    }
    
    /* Mejora para touch en overlay */
    @media (hover: none) and (pointer: coarse) {
      .card.restricted .restricted-overlay {
        opacity: 0.9;
      }
    }
    
    .card.restricted .restricted-overlay i {
      font-size: clamp(2rem, 6vw, 3rem);
      margin-bottom: clamp(10px, 3vw, 15px);
      color: var(--warning-color);
    }
    
    .card.restricted .restricted-overlay span {
      font-size: clamp(0.9rem, 3vw, 1.1rem);
      font-weight: 600;
    }

    /* Layout de Tarjetas en secciones internas */
    .section-content:not(#section-inicio) .cards-row {
      position: relative; 
      display: block; 
      min-height: 100px; /* Reducido para permitir ajuste automático */
      margin-top: 0;
    }
    
    .movable-card-wrapper {
      position: absolute; 
      width: 48%; 
      min-height: 150px;
      cursor: move !important;
      padding: 0;
    }
    
    .movable-card-wrapper .card {
      margin: 0 !important; 
      height: 100% !important;
      transform: none !important; 
    }

    /* Estilos de Edición optimizados para touch */
    .active-editable { 
      outline: 2px dashed var(--primary-color); 
    }

    /* Movable Text Box mejorado para dispositivos táctiles */
    .movable {
      position: absolute !important;
      z-index: 1000;
      border: none !important; 
      cursor: default !important;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      touch-action: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    .movable.active-editable {
      border: 2px dashed var(--primary-color) !important;
      cursor: move !important;
    }
    
    .movable[contenteditable="true"] {
      cursor: text !important;
      outline: 2px dashed var(--success-color);
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    .text-box {
      padding: clamp(15px, 3vw, 20px);
      min-width: min(250px, 80vw);
      min-height: min(120px, 30vh);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      line-height: 1.6;
    }
    
    .text-box p { 
      margin: 0; 
    } 
    
    /* Cleanup para evitar saltos en texto estático */
    .editable-text:not([contenteditable="true"]):not(.movable) {
      border: 1px solid transparent !important; 
      padding: 5px;                           
      cursor: default;
    }
    
    .editable-text[contenteditable="true"]:not(.movable) {
      border: 1px dashed #ccc !important;
      padding: 5px; 
      cursor: text;
      outline: none !important; 
    }
    
    .hero-title.editable-text,
    .hero-subtitle.editable-text {
      padding: 5px !important;
      border: 1px solid transparent !important;
    }
    
    .hero-title.editable-text[contenteditable="true"],
    .hero-subtitle.editable-text[contenteditable="true"] {
      border: 1px dashed rgba(255, 255, 255, 0.5) !important;
      border-radius: 5px;
      padding: 5px !important;
    }
    
    /* Grid de tarjetas de inicio optimizado */
    .cards-row {
      --bs-gutter-x: clamp(1rem, 3vw, 1.5rem);
      --bs-gutter-y: clamp(1rem, 3vw, 1.5rem);
      display: flex;
      flex-wrap: wrap;
      position: relative;
    }
    
    /* CORRECCIÓN: Estilo específico para las tarjetas de inicio */
    #section-inicio .cards-row > .col {
      flex: 0 0 auto;
      width: 20%; 
      padding: calc(var(--bs-gutter-x) * .5);
      margin-top: var(--bs-gutter-y);
    }
    
    /* Botones mejorados con estilos más suaves */
    .btn-custom {
      border-radius: 8px;
      font-weight: 500; /* Peso de fuente más suave */
      padding: clamp(0.5rem, 2vw, 0.6rem) clamp(1rem, 3vw, 1.2rem);
      transition: var(--transition);
      border: none;
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      min-height: 44px; /* Tamaño mínimo para touch */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-primary-custom {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
    }
    
    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 139, 87, 0.2); /* Sombra más suave */
    }
    
    .btn-outline-primary {
      border: 1px solid var(--primary-color); /* Borde más delgado */
      color: var(--primary-color);
      background: transparent;
    }
    
    .btn-outline-primary:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }
    
    /* Mejora para botones en dispositivos táctiles */
    @media (hover: none) and (pointer: coarse) {
      .btn-custom:hover {
        transform: none;
      }
      
      .btn-custom:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }
    }
    
    /* Estilos para el modo edición optimizados */
    .edit-mode-indicator {
      position: fixed;
      top: clamp(70px, 12vw, 80px);
      right: clamp(10px, 3vw, 20px);
      background: linear-gradient(135deg, var(--warning-color), #ffa726); /* Gradiente más suave */
      color: var(--dark-color);
      padding: clamp(6px, 2vw, 8px) clamp(12px, 3vw, 15px);
      border-radius: 30px;
      font-size: clamp(0.75rem, 2.5vw, 0.85rem);
      z-index: 1050;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* Sombra más suave */
      font-weight: 500; /* Peso de fuente más suave */
      display: flex;
      align-items: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .edit-mode-indicator i {
      margin-right: 8px;
    }
    
    /* Estilos para el login modal optimizados */
    .login-modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      border-radius: 0;
    }
    
    .modal-content {
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      margin: constant(safe-area-inset-top) constant(safe-area-inset-right) constant(safe-area-inset-bottom) constant(safe-area-inset-left);
      margin: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    /* Estilos para elementos de arrastre optimizados */
    .ui-draggable-dragging {
      z-index: 10000 !important;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1) !important; /* Sombra más suave */
      transform: scale(1.02);
    }
    
    .ui-resizable-handle {
      background-color: var(--primary-color);
      border: 2px solid white;
      border-radius: 50%;
      width: clamp(10px, 3vw, 12px) !important;
      height: clamp(10px, 3vw, 12px) !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Sombra más suave */
    }
    
    /* Animaciones optimizadas */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); } /* Movimiento más suave */
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.4s ease; /* Animación más rápida */
    }
    
    /* Responsive Design mejorado */
    @media (max-width: 1200px) {
      #section-inicio .cards-row > .col {
        width: 33.333%;
      }
    }
    
    @media (max-width: 992px) {
      #editSidebar {
        width: min(280px, 80vw);
      }
      
      .navbar-collapse {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-top: 1rem;
        box-shadow: var(--box-shadow);
      }
    }
    
    @media (max-width: 768px) {
      #section-inicio .cards-row > .col {
        width: 50%;
      }
      
      .movable-card-wrapper {
        width: 100%;
        position: relative !important;
        margin-bottom: 1rem;
      }
      
      .navbar-brand-custom {
        font-size: 1.3rem;
      }
    }
    
    @media (max-width: 576px) {
      #section-inicio .cards-row > .col {
        width: 100%;
      }
      
      .card-body {
        padding: 1.25rem;
      }
      
      .edit-mode-indicator {
        top: 70px;
        right: 10px;
      }
      
      /* Mejoras específicas para móviles pequeños */
      .container {
        padding-left: 10px;
        padding-right: 10px;
      }
    }
    
    /* Soporte para orientación landscape en móviles */
    @media (max-height: 500px) and (orientation: landscape) {
      .navbar {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      
      .hero-section {
        padding: 20px 15px;
        margin-bottom: 20px;
      }
      
      .hero-title {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }
      
      .hero-subtitle {
        font-size: 0.9rem;
      }
    }
    
    /* Mejoras para tablets */
    @media (min-width: 768px) and (max-width: 1024px) {
      #section-inicio .cards-row > .col {
        width: 33.333%;
      }
      
      .hero-title {
        font-size: 2.2rem;
      }
      
      .hero-subtitle {
        font-size: 1.1rem;
      }
    }
    
    /* Soporte para navegadores WebKit (Safari) */
    @supports (-webkit-touch-callout: none) {
      .hero-section {
        -webkit-mask-image: -webkit-radial-gradient(white, black);
      }
      
      .card {
        -webkit-transform: translateZ(0);
      }
    }
    
    /* Mejoras para navegadores con soporte a scroll suave */
    @media (prefers-reduced-motion: no-preference) {
      html {
        scroll-behavior: smooth;
      }
    }
    
    /* Mejoras de accesibilidad */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Mejoras visuales adicionales */
    .section-title {
      font-size: clamp(1.8rem, 5vw, 2.2rem);
      font-weight: 600; /* Peso de fuente más suave */
      margin-bottom: clamp(1rem, 3vw, 1.5rem);
      color: var(--secondary-color);
      position: relative;
      padding-bottom: 10px;
    }
    
    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 60px;
      height: 3px; /* Línea más delgada */
      background: var(--primary-color);
      border-radius: 2px;
    }

    /* Estilos mejorados para secciones específicas */
    .section-content:not(#section-inicio) .cards-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .chart-container {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 1.5rem;
    }
    
    .progress-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 1.5rem;
    }
    
    .progress-card .progress {
      height: 8px; /* Barra de progreso más delgada */
      margin: 10px 0;
    }
    
    .data-table {
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }
    
    .data-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500; /* Peso de fuente más suave */
    }
    
    .form-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--box-shadow);
    }
    
    .form-card .form-label {
      font-weight: 500; /* Peso de fuente más suave */
      color: var(--secondary-color);
    }
    
    .metric-card {
      text-align: center;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      background: white;
      box-shadow: var(--box-shadow);
    }
    
    .metric-value {
      font-size: 2.2rem; /* Tamaño más moderado */
      font-weight: 600; /* Peso de fuente más suave */
      margin: 10px 0;
    }
    
    .metric-label {
      font-size: 1rem;
      color: var(--secondary-color);
    }
    
    .metric-change {
      font-size: 0.9rem;
      font-weight: 500; /* Peso de fuente más suave */
    }
    
    .metric-change.positive {
      color: var(--success-color);
    }
    
    .metric-change.negative {
      color: var(--danger-color);
    }
    
    .report-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 1.5rem;
    }
    
    .report-card .report-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .report-card .report-date {
      color: var(--secondary-color);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    .report-card .report-description {
      margin-bottom: 1.5rem;
    }
    
    .goal-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 1.5rem;
    }
    
    .goal-card .goal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .goal-card .goal-deadline {
      color: var(--secondary-color);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    .goal-card .goal-progress {
      margin-bottom: 1rem;
    }
    
    .goal-card .goal-description {
      margin-bottom: 1.5rem;
    }
    
    /* Estilos para la sección de Indicadores Avanzados */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      text-align: center;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--primary-color);
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--dark-color);
    }
    
    .stat-label {
      font-size: 1rem;
      color: var(--secondary-color);
      font-weight: 500;
    }
    
    .chart-wrapper {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 2rem;
    }
    
    .chart-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--secondary-color);
    }
    
    .chart-placeholder {
      height: 300px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--secondary-color);
      font-weight: 500;
    }
    
    .data-table-container {
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      margin-bottom: 2rem;
    }
    
    .table-responsive {
      max-height: 500px;
      overflow-y: auto;
    }
    
    .filter-section {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 2rem;
    }
    
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .last-update {
      font-size: 0.85rem;
      color: var(--secondary-color);
      text-align: right;
      margin-top: 1rem;
    }
    
    .data-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }
    
    .export-btn {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .export-btn:hover {
      background: #3d8b40;
      transform: translateY(-2px);
    }
    
    .refresh-btn {
      background: var(--info-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .refresh-btn:hover {
      background: #29b6f6;
      transform: translateY(-2px);
    }
    
    .data-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #e8f5e9;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    
    .data-status.connected {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .data-status.error {
      background: #ffebee;
      color: #c62828;
    }
    
    .data-status i {
      font-size: 1.2rem;
    }

    /* ESTILOS ESPECÍFICOS PARA LA SECCIÓN DE FORMULARIOS */
    .inspiration-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: var(--border-radius);
      padding: 2.5rem;
      margin-bottom: 2.5rem;
      text-align: center;
      box-shadow: var(--box-shadow);
      border-left: 4px solid var(--primary-color);
    }
    
    .inspiration-quote {
      font-size: 1.4rem;
      font-weight: 500;
      line-height: 1.6;
      color: var(--secondary-color);
      margin-bottom: 1.5rem;
      font-style: italic;
    }
    
    .inspiration-author {
      font-size: 1rem;
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .form-description {
      font-size: 1.1rem;
      line-height: 1.7;
      color: var(--dark-color);
      margin-bottom: 2rem;
      text-align: center;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .form-card-modern {
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      height: 100%;
      position: relative;
      background: white;
    }
    
    .form-card-modern:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
    }
    
    .form-card-header {
      padding: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    
    .form-card-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }
    
    .form-card-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--primary-color);
    }
    
    .form-card-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: var(--dark-color);
    }
    
    .form-card-description {
      font-size: 1rem;
      line-height: 1.6;
      color: var(--secondary-color);
      margin-bottom: 1.5rem;
    }
    
    .form-card-body {
      padding: 1.5rem;
    }
    
    .form-card-features {
      list-style: none;
      padding: 0;
      margin: 0 0 1.5rem 0;
    }
    
    .form-card-features li {
      padding: 0.5rem 0;
      display: flex;
      align-items: center;
    }
    
    .form-card-features li i {
      color: var(--success-color);
      margin-right: 0.75rem;
      font-size: 0.9rem;
    }
    
    .form-card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
    }
    
    .form-card-badge {
      background: var(--primary-color);
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .form-card-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-card-button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(46, 139, 87, 0.3);
      color: white;
    }
    
    .form-card-stats {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .form-stat {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--secondary-color);
    }
    
    .form-stat i {
      color: var(--primary-color);
    }
    
    .form-section-title {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 1rem;
      color: var(--dark-color);
      position: relative;
    }
    
    .form-section-title::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      border-radius: 2px;
    }
    
    .form-section-subtitle {
      font-size: 1.2rem;
      text-align: center;
      margin-bottom: 3rem;
      color: var(--secondary-color);
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }

    /* ESTILOS PARA EL DASHBOARD PROAMBIENTAL */
    .dashboard-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 2rem;
    }
    
    .dashboard-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .dashboard-controls label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--secondary-color);
    }
    
    .dashboard-controls select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      font-size: 0.9rem;
    }
    
    .dashboard-controls .btn-group {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }
    
    .dashboard-controls .btn-group button {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .dashboard-controls .btn-primary {
      background: var(--primary-color);
      color: white;
    }
    
    .dashboard-controls .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .dashboard-controls .btn-secondary {
      background: #f8f9fa;
      color: var(--dark-color);
      border: 1px solid #e2e8f0;
    }
    
    .dashboard-controls .btn-secondary:hover {
      background: #e9ecef;
    }
    
    .dashboard-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .dashboard-summary-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      text-align: center;
    }
    
    .dashboard-summary-card .value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0.5rem 0;
      color: var(--primary-color);
    }
    
    .dashboard-summary-card .label {
      font-size: 0.9rem;
      color: var(--secondary-color);
    }
    
    .dashboard-chart {
      background: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--box-shadow);
      margin-bottom: 2rem;
    }
    
    .dashboard-chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .dashboard-chart-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--dark-color);
      margin: 0;
    }
    
    .dashboard-chart-subtitle {
      font-size: 0.9rem;
      color: var(--secondary-color);
      margin: 0.25rem 0 0 0;
    }
    
    .dashboard-chart-info {
      font-size: 0.8rem;
      color: var(--secondary-color);
    }
    
    .dashboard-chart-container {
      height: 400px;
      position: relative;
    }
    
    .dashboard-no-data {
      text-align: center;
      padding: 2rem;
      color: var(--secondary-color);
    }
    
    .dashboard-footer {
      text-align: center;
      font-size: 0.8rem;
      color: var(--secondary-color);
      margin-top: 2rem;
    }
    
    @media (max-width: 768px) {
      .dashboard-controls {
        grid-template-columns: 1fr;
      }
      
      .dashboard-controls .btn-group {
        flex-direction: column;
      }
      
      .dashboard-summary {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .dashboard-chart-container {
        height: 300px;
      }
    }

    /* ESTILOS PARA EL DASHBOARD DE INDICADORES DE DESECHOS */
    .indicadores-daule {
      --green:#0f766e;
      --bg1:#e6fff7;
      --card:#ffffff;
      --muted:#6b7280;
    }
    
    .indicadores-daule .card {
      background: var(--card);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
    }
    
    .indicadores-daule .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .indicadores-daule select, 
    .indicadores-daule input, 
    .indicadores-daule button {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e6eef0;
      background: white;
    }
    
    .indicadores-daule button {
      background: var(--green);
      color: white;
      border: none;
      cursor: pointer;
    }
    
    .indicadores-daule .chart-wrap {
      margin-top: 12px;
    }
    
    .indicadores-daule footer {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin: 18px 0;
    }
    
    .indicadores-daule .kpis {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    
    .indicadores-daule .kpi {
      flex: 1;
      min-width: 160px;
      background: linear-gradient(180deg, #fff, #f7fffb);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #eef7f4;
    }
    
    .indicadores-daule table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    .indicadores-daule th, 
    .indicadores-daule td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #eef2f6;
    }
    
    @media (max-width: 720px) {
      .indicadores-daule .controls {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* Separación entre dashboards */
    .dashboard-separator {
      margin: 3rem 0;
      border-top: 2px solid #e9ecef;
      position: relative;
    }
    
    .dashboard-separator::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 20px;
      background: var(--light-color);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ESTILOS PARA EL ANÁLISIS DE COMPORTAMIENTO PROAMBIENTAL */
    .proambiental-dashboard {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --primary-dark: #0d5d57;
      --secondary: #2d4cc8;
      --accent: #7c3aed;
      --bg1: #f8fafc;
      --bg2: #f0fdfa;
      --card: #ffffff;
      --muted: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e2e8f0;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      --radius: 12px;
    }

    .proambiental-dashboard .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .proambiental-dashboard .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .proambiental-dashboard .card-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    
    .proambiental-dashboard .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .proambiental-dashboard .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .proambiental-dashboard .control-group label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .proambiental-dashboard .filter-info {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      font-style: italic;
    }
    
    .proambiental-dashboard select {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%230f766e'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      appearance: none;
      padding-right: 40px;
    }
    
    .proambiental-dashboard select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }
    
    .proambiental-dashboard button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
      padding: 12px 18px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .proambiental-dashboard button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .proambiental-dashboard button.secondary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    .proambiental-dashboard button.secondary:hover {
      background: var(--bg1);
    }
    
    .proambiental-dashboard .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    
    .proambiental-dashboard .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .proambiental-dashboard .summary-card {
      background: linear-gradient(135deg, #fff, #f7fffb);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #eef7f4;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
    }
    
    .proambiental-dashboard .summary-card:hover {
      transform: translateY(-2px);
    }
    
    .proambiental-dashboard .summary-title {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    
    .proambiental-dashboard .summary-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .proambiental-dashboard .summary-subtitle {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .proambiental-dashboard .positive {
      color: var(--success);
    }
    
    .proambiental-dashboard .negative {
      color: var(--danger);
    }
    
    .proambiental-dashboard .chart-container {
      position: relative;
      height: 500px;
      margin-top: 20px;
    }
    
    .proambiental-dashboard .chart-container-sm {
      position: relative;
      height: 350px;
      margin-top: 20px;
    }
    
    .proambiental-dashboard .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .proambiental-dashboard .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .proambiental-dashboard .tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }
    
    .proambiental-dashboard .tab-content {
      display: none;
    }
    
    .proambiental-dashboard .tab-content.active {
      display: block;
    }
    
    .proambiental-dashboard table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    .proambiental-dashboard th, .proambiental-dashboard td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .proambiental-dashboard th {
      font-weight: 600;
      color: var(--muted);
      font-size: 14px;
      background-color: #f8fafc;
    }
    
    .proambiental-dashboard tr:hover {
      background-color: #f8fafc;
    }
    
    .proambiental-dashboard .total-row {
      background-color: #f0f9ff;
      font-weight: 600;
    }
    
    .proambiental-dashboard .total-row td {
      border-top: 2px solid var(--primary);
    }
    
    .proambiental-dashboard .statistics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    
    .proambiental-dashboard .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
      transition: transform 0.2s;
    }
    
    .proambiental-dashboard .stat-card:hover {
      transform: translateY(-2px);
    }
    
    .proambiental-dashboard .stat-card h4 {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .proambiental-dashboard .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .proambiental-dashboard .stats-section {
      margin-top: 24px;
    }
    
    .proambiental-dashboard .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    
    .proambiental-dashboard .stat-item {
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
    }
    
    .proambiental-dashboard .stat-item:hover {
      transform: translateY(-2px);
    }
    
    .proambiental-dashboard .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .proambiental-dashboard .stat-number {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .proambiental-dashboard .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      flex-direction: column;
      gap: 12px;
    }
    
    .proambiental-dashboard .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(15, 118, 110, 0.2);
      border-left: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .proambiental-dashboard .export-options {
      display: none;
      position: absolute;
      right: 0;
      top: 40px;
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 8px;
      z-index: 10;
      min-width: 150px;
    }
    
    .proambiental-dashboard .export-options.show {
      display: block;
    }
    
    .proambiental-dashboard .export-option {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .proambiental-dashboard .export-option:hover {
      background: var(--bg1);
    }
    
    .proambiental-dashboard .chart-type-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      align-items: center;
    }
    
    .proambiental-dashboard .chart-type-btn {
      background: white;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .proambiental-dashboard .chart-type-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .proambiental-dashboard .chart-type-btn:hover:not(.active) {
      background: var(--bg1);
      border-color: var(--primary-light);
    }
    
    .proambiental-dashboard .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }
    
    .proambiental-dashboard .chart-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
    }
    
    .proambiental-dashboard .chart-card h3 {
      color: var(--primary);
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 600;
    }
    
    .proambiental-dashboard .category-section {
      margin-bottom: 32px;
    }
    
    .proambiental-dashboard .category-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .proambiental-dashboard .table-responsive {
      overflow-x: auto;
    }
    
    /* Estilos específicos para gráficos de preguntas */
    .proambiental-dashboard .question-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }
    
    .proambiental-dashboard .question-chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
    }
    
    .proambiental-dashboard .question-chart-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
    }
    
    .proambiental-dashboard .question-chart-card h3 {
      color: var(--primary);
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.4;
    }
    
    /* Estilos para mejoras en gráficos */
    .proambiental-dashboard .chart-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .proambiental-dashboard .chart-action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      background: white;
      border: 1px solid var(--border);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .proambiental-dashboard .chart-action-btn:hover {
      background: var(--bg1);
      border-color: var(--primary-light);
    }
    
    .proambiental-dashboard .chart-action-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Mejoras para gráficos más nítidos */
    .proambiental-dashboard canvas {
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
    }
    
    .proambiental-dashboard .chartjs-render-monitor {
      -webkit-filter: none !important;
      filter: none !important;
    }
    
    @media (max-width: 768px) {
      .proambiental-dashboard .controls {
        grid-template-columns: 1fr;
      }
      
      .proambiental-dashboard .action-buttons {
        justify-content: center;
      }
      
      .proambiental-dashboard .chart-container {
        height: 400px;
      }
      
      .proambiental-dashboard .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .proambiental-dashboard .chart-type-selector {
        justify-content: center;
      }
      
      .proambiental-dashboard .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .proambiental-dashboard .question-charts {
        grid-template-columns: 1fr;
      }
      
      .proambiental-dashboard .question-chart-container {
        height: 350px;
      }
      
      .proambiental-dashboard .chart-actions {
        justify-content: center;
      }
    }
    
    /* ESTILOS PARA LA SECCIÓN DE AUTOSUSTENTABILIDAD */
    .autosustentabilidad-dashboard {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --primary-dark: #0d5d57;
      --secondary: #2d4cc8;
      --accent: #7c3aed;
      --bg1: #f8fafc;
      --bg2: #f0fdfa;
      --card: #ffffff;
      --muted: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e2e8f0;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      --radius: 12px;
    }
    
    .autosustentabilidad-dashboard .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .autosustentabilidad-dashboard .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .autosustentabilidad-dashboard .card-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    
    .autosustentabilidad-dashboard .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .autosustentabilidad-dashboard .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .autosustentabilidad-dashboard .control-group label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .autosustentabilidad-dashboard select {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .autosustentabilidad-dashboard select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }
    
    .autosustentabilidad-dashboard .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .autosustentabilidad-dashboard .summary-card {
      background: linear-gradient(135deg, #fff, #f7fffb);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #eef7f4;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
    }
    
    .autosustentabilidad-dashboard .summary-card:hover {
      transform: translateY(-2px);
    }
    
    .autosustentabilidad-dashboard .summary-title {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    
    .autosustentabilidad-dashboard .summary-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .autosustentabilidad-dashboard .summary-subtitle {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .autosustentabilidad-dashboard .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .autosustentabilidad-dashboard .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .autosustentabilidad-dashboard .tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }
    
    .autosustentabilidad-dashboard .tab-content {
      display: none;
    }
    
    .autosustentabilidad-dashboard .tab-content.active {
      display: block;
    }
    
    .autosustentabilidad-dashboard table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    .autosustentabilidad-dashboard th, .autosustentabilidad-dashboard td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .autosustentabilidad-dashboard th {
      font-weight: 600;
      color: var(--muted);
      font-size: 14px;
      background-color: #f8fafc;
    }
    
    .autosustentabilidad-dashboard tr:hover {
      background-color: #f8fafc;
    }
    
    .autosustentabilidad-dashboard .total-row {
      background-color: #f0f9ff;
      font-weight: 600;
    }
    
    .autosustentabilidad-dashboard .total-row td {
      border-top: 2px solid var(--primary);
    }
    
    .autosustentabilidad-dashboard .chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
    }
    
    .autosustentabilidad-dashboard .chart-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
    }
    
    .autosustentabilidad-dashboard .chart-card h3 {
      color: var(--primary);
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 600;
    }
    
    .autosustentabilidad-dashboard .category-section {
      margin-bottom: 32px;
    }
    
    .autosustentabilidad-dashboard .category-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .autosustentabilidad-dashboard .table-responsive {
      overflow-x: auto;
    }
    
    /* ESTILOS PARA LA SECCIÓN DE CARACTERIZACIÓN DE DESECHOS */
    .caracterizacion-dashboard {
      --primary: #7c3aed;
      --primary-light: #8b5cf6;
      --primary-dark: #6d28d9;
      --secondary: #0f766e;
      --accent: #f59e0b;
      --bg1: #f8fafc;
      --bg2: #f5f3ff;
      --card: #ffffff;
      --muted: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #e2e8f0;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      --radius: 12px;
    }
    
    .caracterizacion-dashboard .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .caracterizacion-dashboard .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .caracterizacion-dashboard .card-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    
    .caracterizacion-dashboard .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .caracterizacion-dashboard .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .caracterizacion-dashboard .control-group label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .caracterizacion-dashboard select {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .caracterizacion-dashboard select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }
    
    .caracterizacion-dashboard .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .caracterizacion-dashboard .summary-card {
      background: linear-gradient(135deg, #fff, #f5f3ff);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #e9d5ff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
    }
    
    .caracterizacion-dashboard .summary-card:hover {
      transform: translateY(-2px);
    }
    
    .caracterizacion-dashboard .summary-title {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    
    .caracterizacion-dashboard .summary-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .caracterizacion-dashboard .summary-subtitle {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .caracterizacion-dashboard .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .caracterizacion-dashboard .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .caracterizacion-dashboard .tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }
    
    .caracterizacion-dashboard .tab-content {
      display: none;
    }
    
    .caracterizacion-dashboard .tab-content.active {
      display: block;
    }
    
    .caracterizacion-dashboard table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    .caracterizacion-dashboard th, .caracterizacion-dashboard td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .caracterizacion-dashboard th {
      font-weight: 600;
      color: var(--muted);
      font-size: 14px;
      background-color: #f8fafc;
    }
    
    .caracterizacion-dashboard tr:hover {
      background-color: #f8fafc;
    }
    
    .caracterizacion-dashboard .total-row {
      background-color: #f5f3ff;
      font-weight: 600;
    }
    
    .caracterizacion-dashboard .total-row td {
      border-top: 2px solid var(--primary);
    }
    
    .caracterizacion-dashboard .chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
    }
    
    .caracterizacion-dashboard .chart-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border);
    }
    
    .caracterizacion-dashboard .chart-card h3 {
      color: var(--primary);
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 600;
    }
    
    .caracterizacion-dashboard .category-section {
      margin-bottom: 32px;
    }
    
    .caracterizacion-dashboard .category-title {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    
    .caracterizacion-dashboard .table-responsive {
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div id="editSidebar" class="bg-light d-none-temp p-3 shadow-sm" aria-hidden="true">
    <h5 class="text-primary mb-4"><i class="fas fa-tools"></i> Herramientas de Edición</h5>

    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-layer-group"></i> Elementos</h6>
        
        <button class="btn btn-sm btn-outline-success w-100 mb-2" onclick="showCardCustomizationDialog()">
          <i class="fas fa-credit-card me-1"></i> Añadir Tarjeta Personalizada
        </button>

        <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="addTextBox()">
          <i class="fas fa-square-plus me-1"></i> Agregar Cuadro de Texto
        </button>
        <button class="btn btn-sm btn-outline-danger w-100 mb-4" onclick="deleteSelectedElement()">
          <i class="fas fa-trash me-1"></i> Eliminar Seleccionado
        </button>
        <button class="btn btn-sm btn-outline-warning w-100 mb-2" onclick="deleteSelectedCard()">
          <i class="fas fa-trash-alt me-1"></i> Eliminar Tarjeta
        </button>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-arrows-alt"></i> Posición y Tamaño</h6>
        <label class="form-label small fw-bold">Posición (px)</label>
        <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">X</span>
            <input type="number" id="posLeftInput" class="form-control" min="0" oninput="changePosition('left', this.value)">
            <span class="input-group-text">Y</span>
            <input type="number" id="posTopInput" class="form-control" min="0" oninput="changePosition('top', this.value)">
        </div>
        <label class="form-label small fw-bold">Dimensiones (px)</label>
        <div class="input-group input-group-sm mb-3">
            <span class="input-group-text">Ancho</span>
            <input type="number" id="widthInput" class="form-control" min="50" oninput="changeSize('width', this.value)">
            <span class="input-group-text">Alto</span>
            <input type="number" id="heightInput" class="form-control" min="30" oninput="changeSize('height', this.value)">
        </div>
        <div class="alert alert-info py-1 small">
          Mueve con <strong>flechas</strong> (↑↓←→) para precisión de 1px.
        </div>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-font"></i> Formato</h6>
        <div class="btn-group w-100 mb-2" role="group">
          <button class="btn btn-sm btn-outline-dark" onclick="formatText('bold')" title="Negrita"><i class="fas fa-bold"></i></button>
          <button class="btn btn-sm btn-outline-dark" onclick="formatText('italic')" title="Cursiva"><i class="fas fa-italic"></i></button>
          <button class="btn btn-sm btn-outline-dark" onclick="formatText('underline')" title="Subrayado"><i class="fas fa-underline"></i></button>
          <button class="btn btn-sm btn-outline-primary" onclick="addLink()" title="Añadir enlace"><i class="fas fa-link"></i></button>
        </div>

        <h6 class="sidebar-heading text-secondary mt-3"><i class="fas fa-align-left"></i> Alineación</h6>
        <div class="btn-group w-100 mb-2" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyLeft')"><i class="fas fa-align-left"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyCenter')"><i class="fas fa-align-center"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyRight')"><i class="fas fa-align-right"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyFull')"><i class="fas fa-align-justify"></i></button>
        </div>

        <h6 class="sidebar-heading text-secondary mt-3"><i class="fas fa-list-ul"></i> Listas</h6>
        <div class="btn-group w-100 mb-4" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="Viñetas"><i class="fas fa-list-ul"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="formatText('insertOrderedList')" title="Numeración"><i class="fas fa-list-ol"></i></button>
        </div>
    </div>
    
    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-palette"></i> Estilos Visuales</h6>
        
        <label class="form-label small fw-bold">Tipo de Letra</label>
        <select class="form-select form-select-sm mb-3" id="fontFamilySelect" onchange="changeStyle('fontFamily', this.value)">
          <option value="Arial" style="font-family:Arial">Arial</option>
          <option value="Helvetica" style="font-family:Helvetica">Helvetica</option>
          <option value="Times New Roman" style="font-family:'Times New Roman'">Times New Roman</option>
          <option value="Courier New" style="font-family:'Courier New'">Courier New</option>
          <option value="Verdana" style="font-family:Verdana">Verdana</option>
          <option value="Georgia" style="font-family:Georgia">Georgia</option>
        </select>
        
        <label class="form-label small fw-bold">Tamaño de Fuente</label>
        <div class="input-group input-group-sm mb-3">
          <input type="number" id="fontSizeInput" class="form-control" min="8" max="128" placeholder="Ej: 16"
                 oninput="changeStyle('fontSize', this.value)"> 
          <span class="input-group-text">px</span>
        </div>

        <label class="form-label small fw-bold">Color de Texto</label>
        <input type="color" class="form-control form-control-sm mb-3"
               onchange="changeStyle('color', this.value)">

        <label class="form-label small fw-bold">Fondo</label>
        <input type="color" class="form-control form-control-sm mb-4"
               onchange="changeStyle('hiliteColor', this.value)"> 
    </div>

    <div class="sidebar-section">
        <h6 class="sidebar-heading text-secondary"><i class="fas fa-history"></i> Historial</h6>
        <div class="btn-group w-100 mb-3" role="group">
          <button class="btn btn-sm btn-outline-secondary" onclick="undoAction()" title="Deshacer"><i class="fas fa-undo"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="redoAction()" title="Rehacer"><i class="fas fa-redo"></i></button>
        </div>
    </div>

  </div>

  <!-- Modal para personalizar tarjeta -->
  <div class="modal fade" id="cardCustomizationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header login-modal-header text-white">
          <h5 class="modal-title"><i class="fas fa-palette me-2"></i> Personalizar Tarjeta</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="cardCustomizationForm">
            <div class="mb-3">
              <label for="cardTitleInput" class="form-label">Título de la Tarjeta</label>
              <input type="text" class="form-control" id="cardTitleInput" value="Nueva Tarjeta" required>
            </div>
            <div class="mb-3">
              <label for="cardDescriptionInput" class="form-label">Descripción</label>
              <textarea class="form-control" id="cardDescriptionInput" rows="3">Descripción de la tarjeta personalizada.</textarea>
            </div>
            <div class="mb-3">
              <label for="cardIconSelect" class="form-label">Icono</label>
              <select class="form-select" id="cardIconSelect">
                <option value="fa-bullseye">Objetivo</option>
                <option value="fa-chart-line">Gráfico</option>
                <option value="fa-tasks">Tareas</option>
                <option value="fa-file-alt">Documento</option>
                <option value="fa-clipboard-list">Formulario</option>
                <option value="fa-recycle">Reciclaje</option>
                <option value="fa-leaf">Ecológico</option>
                <option value="fa-globe">Global</option>
                <option value="fa-users">Usuarios</option>
                <option value="fa-cog">Configuración</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="cardColorInput" class="form-label">Color de Fondo</label>
              <input type="color" class="form-control form-control-color" id="cardColorInput" value="#5D6D7E" title="Elige un color">
            </div>
            <div class="mb-3">
              <label for="cardLinkInput" class="form-label">Enlace (URL o #sección)</label>
              <input type="text" class="form-control" id="cardLinkInput" placeholder="#inicio o https://ejemplo.com">
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="cardRestrictedCheck">
              <label class="form-check-label" for="cardRestrictedCheck">
                Tarjeta restringida (requiere login)
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="createCustomCard()">Crear Tarjeta</button>
        </div>
      </div>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand navbar-brand-custom" href="#" onclick="showSection('inicio')">
        <i class="fas fa-recycle"></i> Gestión de Residuos Sólidos
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('inicio')">Inicio</a></li>
          <li class="nav-item"><a class="nav-link restricted-nav" href="#" onclick="showSection('metas')">Metas <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('indicadores')">Indicadores</a></li>
          <li class="nav-item"><a class="nav-link restricted-nav" href="#" onclick="showSection('avances')">Avances <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link restricted-nav" href="#" onclick="showSection('reportes')">Reportes <i class="fas fa-lock ms-1"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('formularios')">Formularios</a></li>
        </ul>
        <ul class="navbar-nav" id="loginBtnContainer">
          <li class="nav-item">
            <button class="btn btn-outline-light btn-custom" type="button" data-bs-toggle="modal" data-bs-target="#loginModal">
              <i class="fas fa-sign-in-alt me-2"></i> Iniciar Sesión
            </button>
          </li>
        </ul>
        <ul class="navbar-nav d-none" id="userNav">
          <li class="nav-item">
            <button id="editToggleBtn" class="btn btn-outline-light btn-custom me-2" onclick="toggleEditMode()">
              <i class="fas fa-edit me-1"></i> Modo Edición
            </button>
          </li>
          <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-bell"></i></a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-1"></i> <span id="userNameDisplay">Usuario</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Gestión de Usuarios</a></li>
              <li><a class="dropdown-item" href="#"><i class="fas fa-address-card me-2"></i> Mi Perfil</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i> Cerrar sesión</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="mainContentWrapper" class="container-fluid" style="margin-left:0;">
    <div class="container mt-4" id="mainContent">
      
      <div id="section-inicio" class="section-content">
        <div class="hero-section">
          <h1 class="hero-title editable-text" id="heroTitle">Sistema de Gestión de Residuos Sólidos</h1>
          <p class="hero-subtitle editable-text" id="heroSubtitle">
            Plataforma integral para monitorear indicadores, gestionar metas y generar reportes para una gestión ambiental eficiente y sostenible.
          </p>
        </div>

        <div class="cards-row mt-3"> 
          <div class="col">
            <div class="card text-white restricted" style="background: linear-gradient(135deg, #5d6d7e, #34495e);" data-card-link="#metas"> 
              <div class="card-body">
                <i class="fas fa-bullseye card-icon"></i>
                <h5 class="card-title editable-text text-white">Metas</h5>
                <p class="card-text editable-text text-white">Definición de objetivos a corto y largo plazo para la reducción de residuos.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white" style="background: linear-gradient(135deg, #4CAF50, #2E7D32);" data-card-link="#indicadores"> 
              <div class="card-body">
                <i class="fas fa-chart-line card-icon"></i>
                <h5 class="card-title editable-text text-white">Indicadores</h5>
                <p class="card-text editable-text text-white">Métricas clave para medir el éxito del plan de gestión.</p>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card restricted" style="background: linear-gradient(135deg, #f4d03f, #f39c12); color: #343a40;" data-card-link="#avances"> 
              <div class="card-body">
                <i class="fas fa-tasks card-icon"></i>
                <h5 class="card-title editable-text" style="color: #343a40;">Avances</h5>
                <p class="card-text editable-text" style="color: #343a40;">Registro del progreso y cumplimiento de las metas establecidas.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white restricted" style="background: linear-gradient(135deg, #3498db, #2980b9);" data-card-link="#reportes"> 
              <div class="card-body">
                <i class="fas fa-file-alt card-icon"></i>
                <h5 class="card-title editable-text text-white">Reportes</h5>
                <p class="card-text editable-text text-white">Generación automática de informes de impacto y sostenibilidad.</p>
              </div>
              <div class="restricted-overlay">
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card text-white" style="background: linear-gradient(135deg, #e74c3c, #c0392b);" data-card-link="#formularios"> 
              <div class="card-body">
                <i class="fas fa-clipboard-list card-icon"></i>
                <h5 class="card-title editable-text text-white">Formularios</h5>
                <p class="card-text editable-text text-white">Acceso a encuestas y herramientas de recolección de datos.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sección de Metas mejorada -->
      <div id="section-metas" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);">
          <h1 class="hero-title editable-text">Definición y Seguimiento de Metas</h1>
          <p class="hero-subtitle editable-text">
            Establezca metas SMART para la gestión de residuos. Monitoree la reducción y el reciclaje.
          </p>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-8">
            <div class="goal-card">
              <div class="goal-title editable-text">Meta de Reducción de Residuos</div>
              <div class="goal-deadline editable-text">Fecha límite: 31 de diciembre 2023</div>
              <div class="goal-progress">
                <div class="d-flex justify-content-between mb-1">
                  <span class="editable-text">Progreso actual</span>
                  <span class="editable-text">65%</span>
                </div>
                <div class="progress">
                  <div class="progress-bar bg-success" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
              <div class="goal-description editable-text">
                Reducir en un 15% la cantidad de residuos sólidos municipales generados para finales del año fiscal actual.
              </div>
              <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-primary">Ver detalles</button>
                <button class="btn btn-sm btn-outline-success">Actualizar progreso</button>
              </div>
            </div>
            
            <div class="goal-card">
              <div class="goal-title editable-text">Meta de Reciclaje</div>
              <div class="goal-deadline editable-text">Fecha límite: 30 de junio 2023</div>
              <div class="goal-progress">
                <div class="d-flex justify-content-between mb-1">
                  <span class="editable-text">Progreso actual</span>
                  <span class="editable-text">42%</span>
                </div>
                <div class="progress">
                  <div class="progress-bar bg-info" role="progressbar" style="width: 42%" aria-valuenow="42" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
              <div class="goal-description editable-text">
                Aumentar la tasa de reciclaje de plásticos y papel al 40% en los próximos 6 meses.
              </div>
              <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-primary">Ver detalles</button>
                <button class="btn btn-sm btn-outline-success">Actualizar progreso</button>
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="metric-card mb-4">
              <i class="fas fa-bullseye fa-2x text-primary"></i>
              <div class="metric-value editable-text">12</div>
              <div class="metric-label editable-text">Metas Activas</div>
            </div>
            
            <div class="metric-card mb-4">
              <i class="fas fa-check-circle fa-2x text-success"></i>
              <div class="metric-value editable-text">8</div>
              <div class="metric-label editable-text">Metas Completadas</div>
            </div>
            
            <div class="metric-card mb-4">
              <i class="fas fa-clock fa-2x text-warning"></i>
              <div class="metric-value editable-text">4</div>
              <div class="metric-label editable-text">Metas en Progreso</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de Indicadores dividida en dos subsecciones -->
      <div id="section-indicadores" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #34495e 0%, #5d6d7e 100%);">
          <h1 class="hero-title editable-text">Indicadores de Gestión de Residuos</h1>
          <p class="hero-subtitle editable-text">
            Análisis integral de datos para la toma de decisiones informadas
          </p>
        </div>
        
        <!-- Navegación entre las dos subsecciones -->
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="card text-white" style="background: linear-gradient(135deg, #0f766e, #14b8a6); cursor: pointer;" onclick="showSubsection('comportamiento-proambiental')">
              <div class="card-body text-center">
                <i class="fas fa-leaf fa-3x mb-3"></i>
                <h3 class="card-title">Comportamiento Proambiental</h3>
                <p class="card-text">Análisis de actitudes y comportamientos hacia el medio ambiente</p>
                <button class="btn btn-light mt-2">Ver Análisis</button>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card text-white" style="background: linear-gradient(135deg, #7c3aed, #8b5cf6); cursor: pointer;" onclick="showSubsection('autosustentabilidad')">
              <div class="card-body text-center">
                <i class="fas fa-seedling fa-3x mb-3"></i>
                <h3 class="card-title">Autosustentabilidad</h3>
                <p class="card-text">Indicadores de sostenibilidad y autogestión ambiental</p>
                <button class="btn btn-light mt-2">Ver Análisis</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Subsección de Comportamiento Proambiental -->
        <div id="subseccion-comportamiento-proambiental" class="subseccion-indicadores">
          <div class="dashboard-separator"></div>
          
          <!-- Dashboard Proambiental -->
          <div class="proambiental-dashboard">
            <div class="card">
              <div class="card-title">
                <i class="fas fa-sliders-h"></i>
                Filtros de Análisis - Comportamiento Proambiental
              </div>
              
              <!-- Controles -->
              <div class="controls" id="controls">
                <div class="control-group">
                  <label for="selectEstadoCivil"><i class="fas fa-heart"></i> Estado Civil</label>
                  <select id="selectEstadoCivil">
                    <option value="">Todos los estados civiles</option>
                  </select>
                  <div class="filter-info" id="estadoCivilInfo">Cargando...</div>
                </div>

                <div class="control-group">
                  <label for="selectEducacion"><i class="fas fa-graduation-cap"></i> Nivel de Educación</label>
                  <select id="selectEducacion">
                    <option value="">Todos los niveles</option>
                  </select>
                  <div class="filter-info" id="educacionInfo">Cargando...</div>
                </div>

                <div class="control-group">
                  <label for="selectSituacionLaboral"><i class="fas fa-briefcase"></i> Situación Laboral</label>
                  <select id="selectSituacionLaboral">
                    <option value="">Todas las situaciones</option>
                  </select>
                  <div class="filter-info" id="situacionLaboralInfo">Cargando...</div>
                </div>

                <div class="control-group">
                  <label for="selectIngreso"><i class="fas fa-money-bill-wave"></i> Ingreso Mensual</label>
                  <select id="selectIngreso">
                    <option value="">Todos los ingresos</option>
                  </select>
                  <div class="filter-info" id="ingresoInfo">Cargando...</div>
                </div>
              </div>
            </div>

            <!-- Tarjetas de resumen -->
            <div class="card">
              <div class="card-title">
                <i class="fas fa-chart-line"></i>
                Resumen General - Comportamiento Proambiental
              </div>
              
              <div class="summary-cards" id="summaryCards">
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-users"></i> Total de Encuestados
                  </div>
                  <div class="summary-value" id="summaryTotal">0</div>
                  <div class="summary-subtitle">
                    <span>Muestra representativa del cantón</span>
                  </div>
                </div>
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-home"></i> Tipo de Hogar Predominante
                  </div>
                  <div class="summary-value" id="summaryHogar">-</div>
                  <div class="summary-subtitle" id="summaryHogarChange">
                    <span>% del total</span>
                  </div>
                </div>
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-user-graduate"></i> Educación Predominante
                  </div>
                  <div class="summary-value" id="summaryEducacion">-</div>
                  <div class="summary-subtitle" id="summaryEducacionChange">
                    <span>% del total</span>
                  </div>
                </div>
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-briefcase"></i> Situación Laboral Predominante
                  </div>
                  <div class="summary-value" id="summaryLaboral">-</div>
                  <div class="summary-subtitle" id="summaryLaboralChange">
                    <span>% del total</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Gráficos y visualizaciones -->
            <div class="card">
              <div class="card-title">
                <i class="fas fa-chart-bar"></i>
                Visualización de Datos - Comportamiento Proambiental
              </div>
              
              <div class="chart-actions">
                <div class="chart-action-btn" data-chart-type="bar">
                  <i class="fas fa-chart-bar"></i> Barras
                </div>
                <div class="chart-action-btn active" data-chart-type="pie">
                  <i class="fas fa-chart-pie"></i> Torta
                </div>
                <div class="chart-action-btn" data-chart-type="line">
                  <i class="fas fa-chart-line"></i> Líneas
                </div>
              </div>
              
              <div class="tabs">
                <div class="tab active" data-tab="demographics">Distribución Demográfica</div>
                <div class="tab" data-tab="sociocultural">Determinantes Socioculturales</div>
                <div class="tab" data-tab="afectivos">Determinantes Afectivos</div>
                <div class="tab" data-tab="cognitivos">Determinantes Cognitivos</div>
                <div class="tab" data-tab="ambiental">Sustentabilidad Ambiental</div>
                <div class="tab" data-tab="economica">Sustentabilidad Económica</div>
                <div class="tab" data-tab="comunitario">Desarrollo Comunitario</div>
              </div>
              
              <div class="tab-content active" id="demographics">
                <div class="charts-grid">
                  <div class="chart-card">
                    <h3>Distribución por Estado Civil</h3>
                    <div class="chart-container-sm">
                      <canvas id="estadoCivilChart"></canvas>
                    </div>
                  </div>
                  <div class="chart-card">
                    <h3>Distribución por Nivel Educativo</h3>
                    <div class="chart-container-sm">
                      <canvas id="educacionChart"></canvas>
                    </div>
                  </div>
                  <div class="chart-card">
                    <h3>Distribución por Situación Laboral</h3>
                    <div class="chart-container-sm">
                      <canvas id="laboralChart"></canvas>
                    </div>
                  </div>
                  <div class="chart-card">
                    <h3>Distribución por Ingreso Mensual</h3>
                    <div class="chart-container-sm">
                      <canvas id="ingresoChart"></canvas>
                    </div>
                  </div>
                  <div class="chart-card">
                    <h3>Distribución por Tipo de Hogar</h3>
                    <div class="chart-container-sm">
                      <canvas id="hogarChart"></canvas>
                    </div>
                  </div>
                  <div class="chart-card">
                    <h3>Distribución por Grupos de Edad</h3>
                    <div class="chart-container-sm">
                      <canvas id="edadChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Determinantes Socioculturales -->
              <div class="tab-content" id="sociocultural">
                <div class="question-charts">
                  <div class="question-chart-card">
                    <h3>¿Conoce usted qué son los desechos sólidos domiciliarios?</h3>
                    <div class="question-chart-container">
                      <canvas id="socioculturalChart1"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Cree usted que existe un comportamiento adecuado en el manejo de los desechos sólidos domiciliarios en la comunidad?</h3>
                    <div class="question-chart-container">
                      <canvas id="socioculturalChart2"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Se debe separar los desechos sólidos según su tipo ejemplo: (papel - plástico - orgánico - inorgánico)?</h3>
                    <div class="question-chart-container">
                      <canvas id="socioculturalChart3"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Es importante la correcta clasificación de los desechos sólidos orgánicos e inorgánicos en el hogar?</h3>
                    <div class="question-chart-container">
                      <canvas id="socioculturalChart4"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Cree que el comportamiento de la comunidad influye en deterioro del medio ambiente?</h3>
                    <div class="question-chart-container">
                      <canvas id="socioculturalChart5"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Dedica tiempo para reducir, reutilizar y/o reciclar los desechos sólidos que se generan en el hogar?</h3>
                    <div class="question-chart-container">
                      <canvas id="socioculturalChart6"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Los desechos sólidos son un gran problema para la comunidad?</h3>
                    <div class="question-chart-container">
                      <canvas id="socioculturalChart7"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Determinantes Afectivos -->
              <div class="tab-content" id="afectivos">
                <div class="question-charts">
                  <div class="question-chart-card">
                    <h3>¿Le preocupa el exceso de desechos sólidos domiciliarios?</h3>
                    <div class="question-chart-container">
                      <canvas id="afectivosChart1"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Considera que los desechos sólidos domiciliarios intervienen en las consecuencias climáticas?</h3>
                    <div class="question-chart-container">
                      <canvas id="afectivosChart2"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Le afecta emocionalmente cuando escucha noticias acerca de los desastres naturales?</h3>
                    <div class="question-chart-container">
                      <canvas id="afectivosChart3"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Siente frustración debido a la falta de acciones significativas para abordar la generación de los desechos sólidos?</h3>
                    <div class="question-chart-container">
                      <canvas id="afectivosChart4"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Considera importante pensar en el tipo de planeta que dejaremos a las futuras generaciones?</h3>
                    <div class="question-chart-container">
                      <canvas id="afectivosChart5"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Determinantes Cognitivos -->
              <div class="tab-content" id="cognitivos">
                <div class="question-charts">
                  <div class="question-chart-card">
                    <h3>¿Es consciente del impacto de los desechos sólidos domiciliarios en el medio ambiente?</h3>
                    <div class="question-chart-container">
                      <canvas id="cognitivosChart1"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Investiga frecuentemente acerca de temas medio ambientales?</h3>
                    <div class="question-chart-container">
                      <canvas id="cognitivosChart2"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Conoce las consecuencias de la acumulación de los desechos sólidos domiciliarios?</h3>
                    <div class="question-chart-container">
                      <canvas id="cognitivosChart3"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Conoce los beneficios de reutilizar un residuo domiciliario?</h3>
                    <div class="question-chart-container">
                      <canvas id="cognitivosChart4"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿La falta de información es un obstáculo para la correcta gestión de los residuos sólidos domiciliario?</h3>
                    <div class="question-chart-container">
                      <canvas id="cognitivosChart5"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Sustentabilidad Ambiental -->
              <div class="tab-content" id="ambiental">
                <div class="question-charts">
                  <div class="question-chart-card">
                    <h3>¿Los desechos orgánicos generados en el hogar pueden tener otra funcionalidad?</h3>
                    <div class="question-chart-container">
                      <canvas id="ambientalChart1"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿La acumulación de desechos afectan a la salud de la población?</h3>
                    <div class="question-chart-container">
                      <canvas id="ambientalChart2"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿La reducción, reciclaje y la reutilización de los desechos sólidos puede cuidar al medio ambiente y a la vida silvestre?</h3>
                    <div class="question-chart-container">
                      <canvas id="ambientalChart3"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Cree que la transformación de desechos sólidos en nuevos productos puede contribuir significativamente a la reducción de la generación de desechos?</h3>
                    <div class="question-chart-container">
                      <canvas id="ambientalChart4"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Necesita más información acerca de educación ambiental?</h3>
                    <div class="question-chart-container">
                      <canvas id="ambientalChart5"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Sustentabilidad Económica -->
              <div class="tab-content" id="economica">
                <div class="question-charts">
                  <div class="question-chart-card">
                    <h3>¿En su hogar practica la separación de los desechos para el reciclaje y le representa algún ingreso?</h3>
                    <div class="question-chart-container">
                      <canvas id="economicaChart1"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Los desechos sólidos generados en el hogar pueden ser reutilizados para una nueva función o creación de un producto?</h3>
                    <div class="question-chart-container">
                      <canvas id="economicaChart2"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Cree que el manejo adecuado de los desechos sólidos domiciliarios podría aportar al desarrollo económico comunitario?</h3>
                    <div class="question-chart-container">
                      <canvas id="economicaChart3"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Los emprendimientos en base a la reutilización de los desechos aporta a su economía?</h3>
                    <div class="question-chart-container">
                      <canvas id="economicaChart4"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿El manejo adecuado de los desechos sólidos domiciliarios ofrece oportunidades para el emprendimiento?</h3>
                    <div class="question-chart-container">
                      <canvas id="economicaChart5"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Desarrollo Comunitario -->
              <div class="tab-content" id="comunitario">
                <div class="question-charts">
                  <div class="question-chart-card">
                    <h3>¿Es posible reducir la generación de residuos sólidos domiciliarios por medio de eventos de concientización?</h3>
                    <div class="question-chart-container">
                      <canvas id="comunitarioChart1"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Participaría en talleres de buenas prácticas y capacitaciones para el correcto manejo de los desechos sólidos domiciliarios?</h3>
                    <div class="question-chart-container">
                      <canvas id="comunitarioChart2"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿El manejo adecuado de los desechos sólidos domiciliarios puede tener un impacto significativo al medio ambiente?</h3>
                    <div class="question-chart-container">
                      <canvas id="comunitarioChart3"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Está dispuesto a participar en un emprendimiento en base al uso de los desechos sólidos?</h3>
                    <div class="question-chart-container">
                      <canvas id="comunitarioChart4"></canvas>
                    </div>
                  </div>
                  <div class="question-chart-card">
                    <h3>¿Participaría a una feria de emprendimientos comunitarios en base a desechos domiciliarios reutilizados?</h3>
                    <div class="question-chart-container">
                      <canvas id="comunitarioChart5"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tablas Resumen -->
            <div class="card">
              <div class="card-title">
                <i class="fas fa-table"></i>
                Tablas Resumen por Categorías - Comportamiento Proambiental
              </div>
              
              <div class="tabs">
                <div class="tab active" data-tab="tabla-demografica">Datos Demográficos</div>
                <div class="tab" data-tab="tabla-sociocultural">Determinantes Socioculturales</div>
                <div class="tab" data-tab="tabla-afectivos">Determinantes Afectivos</div>
                <div class="tab" data-tab="tabla-cognitivos">Determinantes Cognitivos</div>
                <div class="tab" data-tab="tabla-ambiental">Sustentabilidad Ambiental</div>
                <div class="tab" data-tab="tabla-economica">Sustentabilidad Económica</div>
                <div class="tab" data-tab="tabla-comunitario">Desarrollo Comunitario</div>
              </div>
              
              <div class="tab-content active" id="tabla-demografica">
                <div class="category-section">
                  <div class="category-title">Estado Civil</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Estado Civil</th>
                          <th style="text-align:right">Cantidad</th>
                          <th style="text-align:right">% del Total</th>
                        </tr>
                      </thead>
                      <tbody id="tablaEstadoCivil"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Total</strong></td>
                          <td style="text-align:right"><strong id="totalEstadoCivil">0</strong></td>
                          <td style="text-align:right"><strong>100%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
                
                <div class="category-section">
                  <div class="category-title">Distribución por Edades</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Grupo de Edad</th>
                          <th style="text-align:right">Cantidad</th>
                          <th style="text-align:right">% del Total</th>
                        </tr>
                      </thead>
                      <tbody id="tablaEdades"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Total</strong></td>
                          <td style="text-align:right"><strong id="totalEdades">0</strong></td>
                          <td style="text-align:right"><strong>100%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
                
                <div class="category-section">
                  <div class="category-title">Nivel de Educación</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Nivel Educativo</th>
                          <th style="text-align:right">Cantidad</th>
                          <th style="text-align:right">% del Total</th>
                        </tr>
                      </thead>
                      <tbody id="tablaEducacion"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Total</strong></td>
                          <td style="text-align:right"><strong id="totalEducacion">0</strong></td>
                          <td style="text-align:right"><strong>100%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
                
                <div class="category-section">
                  <div class="category-title">Situación Laboral</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Situación Laboral</th>
                          <th style="text-align:right">Cantidad</th>
                          <th style="text-align:right">% del Total</th>
                        </tr>
                      </thead>
                      <tbody id="tablaLaboral"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Total</strong></td>
                          <td style="text-align:right"><strong id="totalLaboral">0</strong></td>
                          <td style="text-align:right"><strong>100%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
                
                <div class="category-section">
                  <div class="category-title">Ingreso Mensual</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Nivel de Ingreso</th>
                          <th style="text-align:right">Cantidad</th>
                          <th style="text-align:right">% del Total</th>
                        </tr>
                      </thead>
                      <tbody id="tablaIngreso"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Total</strong></td>
                          <td style="text-align:right"><strong id="totalIngreso">0</strong></td>
                          <td style="text-align:right"><strong>100%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
                
                <div class="category-section">
                  <div class="category-title">Tipo de Hogar</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Tipo de Hogar</th>
                          <th style="text-align:right">Cantidad</th>
                          <th style="text-align:right">% del Total</th>
                        </tr>
                      </thead>
                      <tbody id="tablaHogar"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Total</strong></td>
                          <td style="text-align:right"><strong id="totalHogar">0</strong></td>
                          <td style="text-align:right"><strong>100%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="tabla-sociocultural">
                <div class="category-section">
                  <div class="category-title">Determinantes Socioculturales</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Pregunta</th>
                          <th style="text-align:center">Totalmente Desacuerdo</th>
                          <th style="text-align:center">Desacuerdo</th>
                          <th style="text-align:center">Indiferente</th>
                          <th style="text-align:center">De Acuerdo</th>
                          <th style="text-align:center">Totalmente Acuerdo</th>
                          <th style="text-align:center">Promedio</th>
                        </tr>
                      </thead>
                      <tbody id="tablaSociocultural"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Promedio General</strong></td>
                          <td style="text-align:center"><strong id="promedioSocioculturalTD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioSocioculturalD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioSocioculturalI">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioSocioculturalA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioSocioculturalTA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioSociocultural">0%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="tabla-afectivos">
                <div class="category-section">
                  <div class="category-title">Determinantes Afectivos</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Pregunta</th>
                          <th style="text-align:center">Totalmente Desacuerdo</th>
                          <th style="text-align:center">Desacuerdo</th>
                          <th style="text-align:center">Indiferente</th>
                          <th style="text-align:center">De Acuerdo</th>
                          <th style="text-align:center">Totalmente Acuerdo</th>
                          <th style="text-align:center">Promedio</th>
                        </tr>
                      </thead>
                      <tbody id="tablaAfectivos"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Promedio General</strong></td>
                          <td style="text-align:center"><strong id="promedioAfectivosTD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAfectivosD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAfectivosI">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAfectivosA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAfectivosTA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAfectivos">0%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="tabla-cognitivos">
                <div class="category-section">
                  <div class="category-title">Determinantes Cognitivos</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Pregunta</th>
                          <th style="text-align:center">Totalmente Desacuerdo</th>
                          <th style="text-align:center">Desacuerdo</th>
                          <th style="text-align:center">Indiferente</th>
                          <th style="text-align:center">De Acuerdo</th>
                          <th style="text-align:center">Totalmente Acuerdo</th>
                          <th style="text-align:center">Promedio</th>
                        </tr>
                      </thead>
                      <tbody id="tablaCognitivos"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Promedio General</strong></td>
                          <td style="text-align:center"><strong id="promedioCognitivosTD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioCognitivosD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioCognitivosI">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioCognitivosA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioCognitivosTA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioCognitivos">0%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="tabla-ambiental">
                <div class="category-section">
                  <div class="category-title">Sustentabilidad Ambiental</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Pregunta</th>
                          <th style="text-align:center">Totalmente Desacuerdo</th>
                          <th style="text-align:center">Desacuerdo</th>
                          <th style="text-align:center">Indiferente</th>
                          <th style="text-align:center">De Acuerdo</th>
                          <th style="text-align:center">Totalmente Acuerdo</th>
                          <th style="text-align:center">Promedio</th>
                        </tr>
                      </thead>
                      <tbody id="tablaAmbiental"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Promedio General</strong></td>
                          <td style="text-align:center"><strong id="promedioAmbientalTD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAmbientalD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAmbientalI">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAmbientalA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAmbientalTA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioAmbiental">0%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="tabla-economica">
                <div class="category-section">
                  <div class="category-title">Sustentabilidad Económica</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Pregunta</th>
                          <th style="text-align:center">Totalmente Desacuerdo</th>
                          <th style="text-align:center">Desacuerdo</th>
                          <th style="text-align:center">Indiferente</th>
                          <th style="text-align:center">De Acuerdo</th>
                          <th style="text-align:center">Totalmente Acuerdo</th>
                          <th style="text-align:center">Promedio</th>
                        </tr>
                      </thead>
                      <tbody id="tablaEconomica"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Promedio General</strong></td>
                          <td style="text-align:center"><strong id="promedioEconomicaTD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioEconomicaD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioEconomicaI">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioEconomicaA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioEconomicaTA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioEconomica">0%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="tabla-comunitario">
                <div class="category-section">
                  <div class="category-title">Desarrollo Comunitario</div>
                  <div class="table-responsive">
                    <table>
                      <thead>
                        <tr>
                          <th>Pregunta</th>
                          <th style="text-align:center">Totalmente Desacuerdo</th>
                          <th style="text-align:center">Desacuerdo</th>
                          <th style="text-align:center">Indiferente</th>
                          <th style="text-align:center">De Acuerdo</th>
                          <th style="text-align:center">Totalmente Acuerdo</th>
                          <th style="text-align:center">Promedio</th>
                        </tr>
                      </thead>
                      <tbody id="tablaComunitario"></tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td><strong>Promedio General</strong></td>
                          <td style="text-align:center"><strong id="promedioComunitarioTD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioComunitarioD">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioComunitarioI">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioComunitarioA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioComunitarioTA">0%</strong></td>
                          <td style="text-align:center"><strong id="promedioComunitario">0%</strong></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <footer>
              <p>Panel de Análisis de Comportamiento Proambiental - Cantón Daule</p>
            </footer>
          </div>
        </div>

        <!-- Subsección de Autosustentabilidad -->
        <div id="subseccion-autosustentabilidad" class="subseccion-indicadores" style="display: none;">
          <div class="dashboard-separator"></div>
          
          <!-- Dashboard Autosustentabilidad -->
          <div class="autosustentabilidad-dashboard">
            <div class="card">
              <div class="card-title">
                <i class="fas fa-seedling"></i>
                Análisis de Autosustentabilidad
              </div>
              
              <p>Esta sección analiza los indicadores de autosustentabilidad relacionados con:</p>
              <ul>
                <li>Prácticas de reciclaje y reutilización en hogares</li>
                <li>Generación de ingresos a partir de residuos</li>
                <li>Emprendimientos sostenibles</li>
                <li>Participación comunitaria en gestión de residuos</li>
              </ul>
              
              <div class="summary-cards">
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-recycle"></i> Tasa de Reciclaje
                  </div>
                  <div class="summary-value">42%</div>
                  <div class="summary-subtitle">
                    <span class="positive"><i class="fas fa-arrow-up"></i> 5% vs año anterior</span>
                  </div>
                </div>
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-money-bill-wave"></i> Ingresos por Reciclaje
                  </div>
                  <div class="summary-value">$12,500</div>
                  <div class="summary-subtitle">
                    <span>Generados en el último trimestre</span>
                  </div>
                </div>
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-store"></i> Emprendimientos Verdes
                  </div>
                  <div class="summary-value">18</div>
                  <div class="summary-subtitle">
                    <span>Registrados en la comunidad</span>
                  </div>
                </div>
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-users"></i> Participación Comunitaria
                  </div>
                  <div class="summary-value">65%</div>
                  <div class="summary-subtitle">
                    <span class="positive"><i class="fas fa-arrow-up"></i> 12% vs año anterior</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-title">
                <i class="fas fa-chart-bar"></i>
                Indicadores de Autosustentabilidad
              </div>
              
              <div class="tabs">
                <div class="tab active" data-tab="autosustentabilidad-general">Indicadores Generales</div>
                <div class="tab" data-tab="autosustentabilidad-economica">Indicadores Económicos</div>
                <div class="tab" data-tab="autosustentabilidad-social">Indicadores Sociales</div>
                <div class="tab" data-tab="autosustentabilidad-ambiental">Indicadores Ambientales</div>
              </div>
              
              <div class="tab-content active" id="autosustentabilidad-general">
                <div class="chart-card">
                  <h3>Evolución de la Tasa de Reciclaje</h3>
                  <div class="chart-container">
                    <canvas id="reciclajeChart"></canvas>
                  </div>
                </div>
                
                <div class="chart-card">
                  <h3>Participación en Programas de Autosustentabilidad</h3>
                  <div class="chart-container">
                    <canvas id="participacionChart"></canvas>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="autosustentabilidad-economica">
                <div class="chart-card">
                  <h3>Ingresos Generados por Reciclaje</h3>
                  <div class="chart-container">
                    <canvas id="ingresosChart"></canvas>
                  </div>
                </div>
                
                <div class="chart-card">
                  <h3>Distribución de Emprendimientos Verdes</h3>
                  <div class="chart-container">
                    <canvas id="emprendimientosChart"></canvas>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="autosustentabilidad-social">
                <div class="chart-card">
                  <h3>Nivel de Conocimiento sobre Autosustentabilidad</h3>
                  <div class="chart-container">
                    <canvas id="conocimientoChart"></canvas>
                  </div>
                </div>
                
                <div class="chart-card">
                  <h3>Satisfacción con Programas Comunitarios</h3>
                  <div class="chart-container">
                    <canvas id="satisfaccionChart"></canvas>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="autosustentabilidad-ambiental">
                <div class="chart-card">
                  <h3>Reducción de Residuos por Hogar</h3>
                  <div class="chart-container">
                    <canvas id="reduccionChart"></canvas>
                  </div>
                </div>
                
                <div class="chart-card">
                  <h3>Uso de Técnicas de Compostaje</h3>
                  <div class="chart-container">
                    <canvas id="compostajeChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            
            <footer>
              <p>Panel de Análisis de Autosustentabilidad - Cantón Daule</p>
            </footer>
          </div>
        </div>

        <!-- Subsección de Caracterización de Desechos Sólidos -->
        <div id="subseccion-caracterizacion-desechos" class="subseccion-indicadores" style="display: none;">
          <div class="dashboard-separator"></div>
          
          <!-- Dashboard Caracterización de Desechos -->
          <div class="caracterizacion-dashboard">
            <div class="card">
              <div class="card-title">
                <i class="fas fa-weight"></i>
                Caracterización de Desechos Sólidos - Comunidad de Daule
              </div>
              
              <p>Esta sección presenta un análisis detallado de la composición, volumen y manejo de los desechos sólidos en la comunidad de Daule:</p>
              
              <div class="summary-cards">
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-trash"></i> Generación Total Diaria
                  </div>
                  <div class="summary-value">15.8 t</div>
                  <div class="summary-subtitle">
                    <span>Toneladas por día</span>
                  </div>
                </div>
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-percentage"></i> Orgánicos
                  </div>
                  <div class="summary-value">52%</div>
                  <div class="summary-subtitle">
                    <span>Del total de residuos</span>
                  </div>
                </div>
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-recycle"></i> Reciclables
                  </div>
                  <div class="summary-value">28%</div>
                  <div class="summary-subtitle">
                    <span>Potencialmente reciclables</span>
                  </div>
                </div>
                <div class="summary-card">
                  <div class="summary-title">
                    <i class="fas fa-ban"></i> No Reciclables
                  </div>
                  <div class="summary-value">20%</div>
                  <div class="summary-subtitle">
                    <span>Requieren disposición final</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-title">
                <i class="fas fa-chart-pie"></i>
                Composición de Residuos Sólidos
              </div>
              
              <div class="tabs">
                <div class="tab active" data-tab="composicion-general">Composición General</div>
                <div class="tab" data-tab="composicion-zonas">Por Zonas</div>
                <div class="tab" data-tab="composicion-temporal">Variación Temporal</div>
                <div class="tab" data-tab="composicion-manejo">Sistemas de Manejo</div>
              </div>
              
              <div class="tab-content active" id="composicion-general">
                <div class="chart-card">
                  <h3>Composición Porcentual de Residuos</h3>
                  <div class="chart-container">
                    <canvas id="composicionChart"></canvas>
                  </div>
                </div>
                
                <div class="chart-card">
                  <h3>Generación per cápita</h3>
                  <div class="chart-container">
                    <canvas id="perCapitaChart"></canvas>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="composicion-zonas">
                <div class="chart-card">
                  <h3>Generación de Residuos por Zona</h3>
                  <div class="chart-container">
                    <canvas id="zonasChart"></canvas>
                  </div>
                </div>
                
                <div class="chart-card">
                  <h3>Composición Diferenciada por Zona</h3>
                  <div class="chart-container">
                    <canvas id="composicionZonasChart"></canvas>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="composicion-temporal">
                <div class="chart-card">
                  <h3>Variación Estacional de Residuos</h3>
                  <div class="chart-container">
                    <canvas id="estacionalChart"></canvas>
                  </div>
                </div>
                
                <div class="chart-card">
                  <h3>Tendencia Anual de Generación</h3>
                  <div class="chart-container">
                    <canvas id="tendenciaChart"></canvas>
                  </div>
                </div>
              </div>
              
              <div class="tab-content" id="composicion-manejo">
                <div class="chart-card">
                  <h3>Sistemas de Recolección</h3>
                  <div class="chart-container">
                    <canvas id="recoleccionChart"></canvas>
                  </div>
                </div>
                
                <div class="chart-card">
                  <h3>Disposición Final de Residuos</h3>
                  <div class="chart-container">
                    <canvas id="disposicionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-title">
                <i class="fas fa-table"></i>
                Datos Detallados de Caracterización
              </div>
              
              <div class="table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th>Tipo de Residuo</th>
                      <th>Peso (kg/día)</th>
                      <th>Porcentaje</th>
                      <th>Densidad (kg/m³)</th>
                      <th>Humedad (%)</th>
                      <th>Valor Calórico (kcal/kg)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Orgánicos</td>
                      <td>8,216</td>
                      <td>52%</td>
                      <td>290</td>
                      <td>65%</td>
                      <td>2,500</td>
                    </tr>
                    <tr>
                      <td>Papel y Cartón</td>
                      <td>1,896</td>
                      <td>12%</td>
                      <td>85</td>
                      <td>12%</td>
                      <td>4,000</td>
                    </tr>
                    <tr>
                      <td>Plásticos</td>
                      <td>1,580</td>
                      <td>10%</td>
                      <td>65</td>
                      <td>5%</td>
                      <td>6,500</td>
                    </tr>
                    <tr>
                      <td>Vidrio</td>
                      <td>948</td>
                      <td>6%</td>
                      <td>280</td>
                      <td>2%</td>
                      <td>-</td>
                    </tr>
                    <tr>
                      <td>Metales</td>
                      <td>474</td>
                      <td>3%</td>
                      <td>320</td>
                      <td>3%</td>
                      <td>-</td>
                    </tr>
                    <tr>
                      <td>Textiles</td>
                      <td>632</td>
                      <td>4%</td>
                      <td>75</td>
                      <td>15%</td>
                      <td>4,500</td>
                    </tr>
                    <tr>
                      <td>Otros</td>
                      <td>2,054</td>
                      <td>13%</td>
                      <td>180</td>
                      <td>25%</td>
                      <td>3,500</td>
                    </tr>
                    <tr class="total-row">
                      <td><strong>TOTAL</strong></td>
                      <td><strong>15,800</strong></td>
                      <td><strong>100%</strong></td>
                      <td><strong>185</strong></td>
                      <td><strong>45%</strong></td>
                      <td><strong>3,200</strong></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <footer>
              <p>Panel de Caracterización de Desechos Sólidos - Comunidad de Daule</p>
            </footer>
          </div>
        </div>
      </div>

      <!-- Sección de Avances mejorada -->
      <div id="section-avances" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #f39c12 0%, #f7dc6f 100%); color: #343a40;">
          <h1 class="hero-title editable-text" style="color: #343a40;">Monitor de Avances y Cumplimiento</h1>
          <p class="hero-subtitle editable-text" style="color: #343a40;">
            Seguimiento detallado de cada meta y acción implementada. Identifique cuellos de botella y éxitos.
          </p>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="progress-card">
              <h5 class="editable-text">Reducción de Residuos</h5>
              <div class="d-flex justify-content-between mb-1">
                <span class="editable-text">Progreso: 65%</span>
                <span class="editable-text">Meta: 15% reducción</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <div class="mt-3">
                <h6 class="editable-text">Actividades recientes:</h6>
                <ul>
                  <li class="editable-text">Campaña de concientización completada (15% de participación)</li>
                  <li class="editable-text">Implementación de puntos de reciclaje en 5 barrios</li>
                  <li class="editable-text">Reducción del 8% en residuos orgánicos</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="progress-card">
              <h5 class="editable-text">Incremento del Reciclaje</h5>
              <div class="d-flex justify-content-between mb-1">
                <span class="editable-text">Progreso: 42%</span>
                <span class="editable-text">Meta: 40% de reciclaje</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-info" role="progressbar" style="width: 42%" aria-valuenow="42" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <div class="mt-3">
                <h6 class="editable-text">Actividades recientes:</h6>
                <ul>
                  <li class="editable-text">Instalación de 20 contenedores de separación</li>
                  <li class="editable-text">Capacitación a 150 familias en reciclaje</li>
                  <li class="editable-text">Alianza con 3 empresas recicladoras</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-12">
            <div class="chart-container">
              <h5 class="editable-text">Progreso de Metas por Mes</h5>
              <div class="d-flex justify-content-center align-items-center" style="height: 300px; background-color: #f8f9fa; border-radius: 8px;">
                <p class="text-muted editable-text">Gráfico de progreso de metas aparecerá aquí</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-12">
            <div class="data-table">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th class="editable-text">Meta</th>
                    <th class="editable-text">Fecha Inicio</th>
                    <th class="editable-text">Fecha Límite</th>
                    <th class="editable-text">Progreso</th>
                    <th class="editable-text">Estado</th>
                    <th class="editable-text">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="editable-text">Reducción del 15% de residuos</td>
                    <td class="editable-text">01/01/2023</td>
                    <td class="editable-text">31/12/2023</td>
                    <td>
                      <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                    <td><span class="badge bg-warning editable-text">En progreso</span></td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary">Detalles</button>
                      <button class="btn btn-sm btn-outline-success">Actualizar</button>
                    </td>
                  </tr>
                  <tr>
                    <td class="editable-text">40% de tasa de reciclaje</td>
                    <td class="editable-text">01/03/2023</td>
                    <td class="editable-text">30/06/2023</td>
                    <td>
                      <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 42%" aria-valuenow="42" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                    <td><span class="badge bg-info editable-text">En progreso</span></td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary">Detalles</button>
                      <button class="btn btn-sm btn-outline-success">Actualizar</button>
                    </td>
                  </tr>
                  <tr>
                    <td class="editable-text">95% de cobertura de recolección</td>
                    <td class="editable-text">01/02/2023</td>
                    <td class="editable-text">31/08/2023</td>
                    <td>
                      <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 78%" aria-valuenow="78" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                    <td><span class="badge bg-warning editable-text">En progreso</span></td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary">Detalles</button>
                      <button class="btn btn-sm btn-outline-success">Actualizar</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de Reportes mejorada -->
      <div id="section-reportes" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);">
          <h1 class="hero-title editable-text">Generación de Documentos y Reportes</h1>
          <p class="hero-subtitle editable-text">
            Genere reportes anuales, trimestrales y de impacto ambiental en formato PDF o Excel.
          </p>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="report-card">
              <div class="report-title editable-text">Reporte Anual de Sostenibilidad 2022</div>
              <div class="report-date editable-text">Generado: 15 de enero, 2023</div>
              <div class="report-description editable-text">
                Resumen ejecutivo y datos consolidados de la gestión de residuos del año 2022, incluyendo indicadores clave y logros.
              </div>
              <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-eye me-1"></i> Vista previa
                </button>
                <button class="btn btn-sm btn-outline-success">
                  <i class="fas fa-download me-1"></i> Descargar PDF
                </button>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="report-card">
              <div class="report-title editable-text">Reporte Trimestral Q1 2023</div>
              <div class="report-date editable-text">Generado: 10 de abril, 2023</div>
              <div class="report-description editable-text">
                Análisis detallado del primer trimestre del año, con comparativas mensuales y proyecciones para el resto del año.
              </div>
              <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-eye me-1"></i> Vista previa
                </button>
                <button class="btn btn-sm btn-outline-success">
                  <i class="fas fa-download me-1"></i> Descargar PDF
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="report-card">
              <div class="report-title editable-text">Reporte de Cumplimiento Normativo</div>
              <div class="report-date editable-text">Generado: 5 de marzo, 2023</div>
              <div class="report-description editable-text">
                Documento que valida el apego a las leyes y regulaciones ambientales locales y nacionales.
              </div>
              <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-eye me-1"></i> Vista previa
                </button>
                <button class="btn btn-sm btn-outline-success">
                  <i class="fas fa-download me-1"></i> Descargar PDF
                </button>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="report-card">
              <div class="report-title editable-text">Análisis de Impacto Ambiental</div>
              <div class="report-date editable-text">Generado: 20 de febrero, 2023</div>
              <div class="report-description editable-text">
                Evaluación del impacto de las operaciones de gestión de residuos en el medio ambiente local.
              </div>
              <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-eye me-1"></i> Vista previa
                </button>
                <button class="btn btn-sm btn-outline-success">
                  <i class="fas fa-download me-1"></i> Descargar PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de Formularios mejorada -->
      <div id="section-formularios" class="section-content">
        <div class="hero-section" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
          <h1 class="hero-title editable-text">Encuestas y Recolección de Datos en Campo</h1>
          <p class="hero-subtitle editable-text">
            Acceda a los formularios externos utilizados para la medición y el análisis del comportamiento ciudadano.
          </p>
        </div>
        
        <!-- Descripción de la sección -->
        <div class="form-description">
          Nuestros formularios están diseñados para capturar información valiosa sobre las prácticas ambientales de la comunidad. 
          Cada encuesta proporciona datos cruciales que nos ayudan a medir el impacto de nuestras iniciativas y a diseñar estrategias 
          más efectivas para la gestión sostenible de residuos.
        </div>
        
        <!-- Tarjetas de formularios modernas -->
        <div class="row mt-4">
          <div class="col-lg-6 mb-4">
            <div class="form-card-modern" data-card-link="https://tally.so/r/nrNo9M">
              <div class="form-card-header">
                <i class="fas fa-clipboard-check form-card-icon"></i>
                <h3 class="form-card-title editable-text">ENCUESTA COMPORTAMIENTO PROAMBIENTAL</h3>
                <p class="form-card-description editable-text">
                  Formulario integral para medir la actitud ciudadana hacia el reciclaje y la autosustentabilidad. 
                  Esta encuesta evalúa conocimientos, prácticas y disposición hacia la gestión responsable de residuos.
                </p>
              </div>
              <div class="form-card-body">
                <ul class="form-card-features">
                  <li><i class="fas fa-check-circle"></i> Evaluación de conocimientos sobre residuos sólidos</li>
                  <li><i class="fas fa-check-circle"></i> Medición de prácticas de reciclaje</li>
                  <li><i class="fas fa-check-circle"></i> Análisis de disposición hacia políticas ambientales</li>
                  <li><i class="fas fa-check-circle"></i> Identificación de barreras para la participación</li>
                </ul>
                
                <div class="form-card-stats">
                  <div class="form-stat">
                    <i class="fas fa-question-circle"></i>
                    <span>47 preguntas</span>
                  </div>
                  <div class="form-stat">
                    <i class="fas fa-users"></i>
                    <span>Diseñado para ciudadanos</span>
                  </div>
                </div>
                
                <div class="form-card-actions">
                  <span class="form-card-badge">Completo</span>
                  <button class="form-card-button" onclick="window.open('https://tally.so/r/nrNo9M', '_blank')">
                    <i class="fas fa-external-link-alt"></i> Acceder al Formulario
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-lg-6 mb-4">
            <div class="form-card-modern" data-card-link="https://tally.so/r/3jd0da">
              <div class="form-card-header">
                <i class="fas fa-weight form-card-icon"></i>
                <h3 class="form-card-title editable-text">MEDICIÓN DE DESECHOS SÓLIDOS (Daule)</h3>
                <p class="form-card-description editable-text">
                  Encuesta técnica especializada para la medición y caracterización de los desechos sólidos 
                  en el cantón Daule. Recopila datos específicos sobre tipos, volúmenes y manejo de residuos.
                </p>
              </div>
              <div class="form-card-body">
                <ul class="form-card-features">
                  <li><i class="fas fa-check-circle"></i> Caracterización de tipos de residuos</li>
                  <li><i class="fas fa-check-circle"></i> Medición de volúmenes y frecuencias</li>
                  <li><i class="fas fa-check-circle"></i> Evaluación de sistemas de recolección</li>
                  <li><i class="fas fa-check-circle"></i> Análisis de destinos finales</li>
                </ul>
                
                <div class="form-card-stats">
                  <div class="form-stat">
                    <i class="fas fa-question-circle"></i>
                    <span>18 preguntas</span>
                  </div>
                  <div class="form-stat">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Específico para Daule</span>
                  </div>
                </div>
                
                <div class="form-card-actions">
                  <span class="form-card-badge">Técnico</span>
                  <button class="form-card-button" onclick="window.open('https://tally.so/r/3jd0da', '_blank')">
                    <i class="fas fa-external-link-alt"></i> Acceder al Formulario
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- CORRECCIÓN: Se ha eliminado la sección "¿Necesita un formulario personalizado?" -->
      </div>
    </div>
  </div>

  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header login-modal-header text-white">
          <h5 class="modal-title"><i class="fas fa-lock me-2"></i> Acceso al Sistema</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="inputEmail" class="form-label">Correo Electrónico</label>
              <input type="email" class="form-control" id="inputEmail" value="a@ug.com" required>
            </div>
            <div class="mb-3">
              <label for="inputPassword" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="inputPassword" value="1234" required>
            </div>
            <div class="d-grid">
              <button type="button" class="btn btn-success mt-3 btn-custom" onclick="handleLogin()">Ingresar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script>
    // Variables globales
    let isEditMode = false;
    let isLoggedIn = false;
    let savedRange = null;
    let activeEditable = null;
    const MOVE_STEP = 1;
    const CONTENT_PADDING = 30; // Reducido para eliminar espacios en blanco
    const RESTRICTED_SECTIONS = ['metas', 'avances', 'reportes'];
    
    // Historial de acciones para undo/redo
    let actionHistory = [];
    let currentHistoryIndex = -1;
    const MAX_HISTORY_SIZE = 50;
    
    // Sistema de navegación
    let navigationHistory = [];
    let currentNavigationIndex = -1;

    // Detectar dispositivo táctil
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // --- Lógica de Navegación (SPA) ---
    function showSection(sectionId, addToHistory = true) {
        if (RESTRICTED_SECTIONS.includes(sectionId) && !isLoggedIn) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 p-3 bg-warning text-dark rounded shadow';
            toast.style.zIndex = '1060';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>Inicia sesión para acceder a esta sección</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
            
            if (sectionId !== 'inicio') {
                 showSection('inicio', addToHistory);
            }
            return;
        }

        if (addToHistory) {
          addToNavigationHistory(sectionId);
        }

        document.querySelectorAll('.section-content').forEach(section => {
            section.style.display = 'none';
        });
        const sectionToShow = document.getElementById(`section-${sectionId}`);
        if (sectionToShow) {
            sectionToShow.style.display = 'block';
        }

        if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (targetMovable) setMovableTextEditMode(targetMovable, false);
            else activeEditable.removeAttribute('contenteditable');
            activeEditable = null;
        }
        updatePositionInputs();
        
        // Cargar datos de Supabase cuando se muestre la sección de indicadores
        if (sectionId === 'indicadores') {
          // Inicializar el dashboard proambiental
          initProambientalDashboard();
        }
        
        setTimeout(updateContentHeight, 50);
        initializeMovableElements();
    }
    
    // Función para mostrar subsecciones dentro de Indicadores
    function showSubsection(subsectionId) {
      // Ocultar todas las subsecciones
      document.querySelectorAll('.subseccion-indicadores').forEach(subsection => {
        subsection.style.display = 'none';
      });
      
      // Mostrar la subsección seleccionada
      const subsectionToShow = document.getElementById(`subseccion-${subsectionId}`);
      if (subsectionToShow) {
        subsectionToShow.style.display = 'block';
        
        // Si es la subsección de comportamiento proambiental, inicializar el dashboard
        if (subsectionId === 'comportamiento-proambiental') {
          initProambientalDashboard();
        }
      }
    }
    
    function navigateToCardLink(link) {
        if (!link) return;

        if (link.startsWith('http')) {
            window.open(link, '_blank');
        } else if (link.startsWith('#')) {
            const sectionId = link.substring(1);
            showSection(sectionId);
        }
    }

    // --- FUNCIÓN MEJORADA: Cálculo optimizado de altura ---
    function updateContentHeight() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        if (!activeSection) return;

        const movableElements = activeSection.querySelectorAll('.movable, .movable-card-wrapper');
        let maxBottom = 0;

        if (movableElements.length === 0) {
            // Si no hay elementos movibles, usar el contenido estático
            const staticContent = activeSection.querySelector('.hero-section');
            if (staticContent) {
                const rect = staticContent.getBoundingClientRect();
                const containerRect = activeSection.getBoundingClientRect();
                const relativeTop = rect.top - containerRect.top;
                const height = rect.height;
                maxBottom = relativeTop + height;
            }
            
            // Aplicar altura mínima solo si hay contenido
            const newMinHeight = maxBottom > 0 ? maxBottom + CONTENT_PADDING : 'auto';
            document.getElementById('mainContent').style.minHeight = newMinHeight;
            return; 
        }

        movableElements.forEach(el => {
            const rect = el.getBoundingClientRect();
            const containerRect = activeSection.getBoundingClientRect();
            const relativeTop = rect.top - containerRect.top;
            const height = el.offsetHeight;
            const bottom = relativeTop + height;
            maxBottom = Math.max(maxBottom, bottom);
        });

        const newMinHeight = maxBottom + CONTENT_PADDING;
        document.getElementById('mainContent').style.minHeight = `${newMinHeight}px`;
    }

    // --- Funciones de Formato, Posición y Elementos Movibles ---
    function saveSelection() {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      if (activeEditable && activeEditable.getAttribute('contenteditable') === 'true' && activeEditable.contains(sel.focusNode)) {
        savedRange = sel.getRangeAt(0).cloneRange();
      }
    }
    
    function restoreSelection() {
      if (!savedRange) return;
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(savedRange);
    }
    
    document.addEventListener('mouseup', saveSelection);
    document.addEventListener('keyup', saveSelection);

    function formatText(command) {
        if (activeEditable && isEditMode) {
            if (activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper')) {
                setMovableTextEditMode(activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper'), true);
            }
            activeEditable.focus();
            restoreSelection(); 
            document.execCommand(command, false, null);
            saveSelection();
        }
    }
    
    function addLink() {
        if (activeEditable && isEditMode) {
            if (activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper')) {
                setMovableTextEditMode(activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper'), true);
            }
            activeEditable.focus();
            restoreSelection();
            
            const url = prompt("Introduce la URL:", "http://");
            if (url && url !== "http://") document.execCommand("createLink", false, url);
            saveSelection();
        }
    }
    
    function changeStyle(property, value) {
        if (!activeEditable || !isEditMode) return;
        
        const targetElement = activeEditable.closest('.movable') || activeEditable.closest('.movable-card-wrapper');

        if (targetElement) {
             setMovableTextEditMode(targetElement, true);
        } else if (!activeEditable.hasAttribute('contenteditable')) {
            activeEditable.setAttribute('contenteditable', 'true');
        }
        
        activeEditable.focus();
        restoreSelection();

        const sel = window.getSelection();
        let rangeEmpty = !sel.rangeCount || sel.isCollapsed || sel.toString().trim() === '';

        if (property === 'hiliteColor') {
            if (!rangeEmpty) {
                document.execCommand('hiliteColor', false, value);
            } else if (activeEditable.closest('.card')) {
                activeEditable.closest('.card').style.backgroundColor = value;
            } else if (activeEditable.classList.contains('movable')) {
                activeEditable.style.backgroundColor = value;
            }
        } else if (property === 'color') {
            document.execCommand('foreColor', false, value);
        } else if (property === 'fontSize') {
            const size = parseInt(value, 10);
            if (isNaN(size) || size < 8 || size > 128) return;

            document.execCommand('fontSize', false, '7');
            const fonts = activeEditable.getElementsByTagName('font');
            for (let i = 0; i < fonts.length; i++) {
                if (fonts[i].size == '7') {
                    if (activeEditable.contains(fonts[i])) {
                        fonts[i].removeAttribute('size');
                        fonts[i].style.fontSize = `${size}px`;
                    }
                }
            }
        } else if (property === 'fontFamily') {
            document.execCommand('fontName', false, value);
        }

        saveSelection();
        activeEditable.focus();
    }
    
    function updatePositionInputs() {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const left = parseFloat(target.style.left.replace('px', '')) || 0;
            const top = parseFloat(target.style.top.replace('px', '')) || 0;
            const width = parseFloat(target.style.width.replace('px', '')) || target.offsetWidth;
            const height = parseFloat(target.style.height.replace('px', '')) || target.offsetHeight;

            document.getElementById('posLeftInput').value = Math.round(left);
            document.getElementById('posTopInput').value = Math.round(top);
            document.getElementById('widthInput').value = Math.round(width);
            document.getElementById('heightInput').value = Math.round(height);
        } else {
            document.getElementById('posLeftInput').value = '';
            document.getElementById('posTopInput').value = '';
            document.getElementById('widthInput').value = '';
            document.getElementById('heightInput').value = '';
        }
    }

    function changePosition(property, value) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const val = parseInt(value, 10);
            if (!isNaN(val) && val >= 0) {
                target.style[property] = `${val}px`;
                updatePositionInputs();
                updateContentHeight();
            }
        }
    }

    function changeSize(property, value) {
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;

        if (target) {
            const val = parseInt(value, 10);
            if (!isNaN(val) && val >= 0) {
                target.style[property] = `${val}px`;
                updatePositionInputs();
                updateContentHeight();
            }
        }
    }

    function setMovableTextEditMode(el, enable) {
        if (!el || !$(el).data('ui-draggable')) return;

        if (enable) {
            if (activeEditable) activeEditable.setAttribute('contenteditable', 'true');
            $(el).draggable('disable');
            $(el).resizable('disable');
            el.classList.add('active-editable');
        } else {
            if (activeEditable) activeEditable.removeAttribute('contenteditable');
            $(el).draggable('enable');
            $(el).resizable('enable');
            el.classList.remove('active-editable'); 
        }
    }
    
    // FUNCIÓN MEJORADA: Hacer elementos arrastrables y redimensionables sin límites
    function makeElementDraggableAndResizable(el) {
        const container = document.querySelector('.section-content[style*="block"]');
        if (!container) return;

        // Calcular límites dinámicos basados en el contenido actual
        const containerHeight = container.scrollHeight;
        const containerWidth = container.offsetWidth;
        
        // Configuración de arrastre sin límites verticales
        const dragOptions = {
            containment: [0, 0, containerWidth, containerHeight + 1000], // Permitir movimiento hacia abajo
            scroll: false,
            start: function(event, ui) { 
                if (el.classList.contains('movable-card-wrapper') && activeEditable) {
                    activeEditable.removeAttribute('contenteditable');
                }
            },
            drag: function(event, ui) { 
                updateContentHeight(); 
            },
            stop: function(event, ui) { 
                updatePositionInputs(); 
                updateContentHeight(); 
            }
        };

        if (isTouchDevice) {
            dragOptions.delay = 200;
            dragOptions.distance = 10;
        }

        $(el).draggable(dragOptions);
        
        $(el).resizable({
            handles: 'all',
            minWidth: 100,
            minHeight: 50,
            disabled: el.closest('#section-inicio') || el.classList.contains('col'), 
            start: function(event, ui) {
                 if (el.classList.contains('movable-card-wrapper') && activeEditable) {
                    activeEditable.removeAttribute('contenteditable');
                }
            },
            resize: function(event, ui) { 
                updatePositionInputs(); 
                updateContentHeight(); 
            },
            stop: function(event, ui) { 
                updateContentHeight(); 
            }
        });
    }

    function initializeMovableElements() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        if (!activeSection) return;

        activeSection.querySelectorAll('.movable, .movable-card-wrapper').forEach(el => {
            if (isEditMode) makeElementDraggableAndResizable(el);
            else { 
                if ($(el).data('ui-draggable')) { $(el).draggable('destroy'); }
                if ($(el).data('ui-resizable')) { $(el).resizable('destroy'); }
            }
        });
    }

    function getActiveContentContainer() {
        const activeSection = document.querySelector('.section-content[style*="block"]');
        return activeSection || document.getElementById('section-inicio');
    }
    
    function addTextBox() {
        const container = getActiveContentContainer();
        const newBox = document.createElement("div");
        newBox.className = "editable-text movable text-box"; 
        newBox.setAttribute("contenteditable", "false"); 
        newBox.innerHTML = "<p>Doble clic para editar este texto...</p>"; 

        newBox.style.position = 'absolute';
        newBox.style.width = '200px'; 
        newBox.style.minHeight = '100px';
        
        const heroSection = container.querySelector('.hero-section');
        const staticContentBottom = heroSection ? heroSection.getBoundingClientRect().bottom - container.getBoundingClientRect().top + 20 : 100;
        
        newBox.style.left = '100px';
        newBox.style.top = `${staticContentBottom}px`; 
        newBox.style.backgroundColor = 'white'; 

        container.appendChild(newBox);
        
        if (isEditMode) {
            makeElementDraggableAndResizable(newBox);
            
            if (activeEditable) {
                activeEditable.classList.remove('active-editable');
                const prevMovable = activeEditable.closest('.movable, .movable-card-wrapper');
                if (prevMovable) setMovableTextEditMode(prevMovable, false);
                else activeEditable.removeAttribute('contenteditable');
            }
            activeEditable = newBox;
            updatePositionInputs();
            newBox.classList.add('active-editable');

            setMovableTextEditMode(newBox, true);
            newBox.focus();
            updateContentHeight();
            
            saveAction({
                type: 'addTextBox',
                element: newBox.outerHTML,
                container: container.id,
                undo: function() {
                    newBox.remove();
                    updateContentHeight();
                },
                redo: function() {
                    container.appendChild(newBox);
                    makeElementDraggableAndResizable(newBox);
                    updateContentHeight();
                }
            });
        }
    }

    // --- Funciones para Tarjetas Personalizables ---
    function showCardCustomizationDialog() {
        const modal = new bootstrap.Modal(document.getElementById('cardCustomizationModal'));
        modal.show();
    }

    function createCustomCard() {
        const title = document.getElementById('cardTitleInput').value || 'Nueva Tarjeta';
        const description = document.getElementById('cardDescriptionInput').value || 'Descripción de la tarjeta personalizada.';
        const icon = document.getElementById('cardIconSelect').value;
        const color = document.getElementById('cardColorInput').value;
        const link = document.getElementById('cardLinkInput').value;
        const isRestricted = document.getElementById('cardRestrictedCheck').checked;
        
        const rgb = hexToRgb(color);
        const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
        const textColor = brightness > 128 ? '#343a40' : 'white';
        
        const activeSection = getActiveContentContainer();
        
        let cardsRow = activeSection.querySelector('.cards-row');
        if (!cardsRow) {
            cardsRow = document.createElement('div');
            cardsRow.className = 'cards-row mt-4';
            activeSection.appendChild(cardsRow);
        }

        const isHomeSection = activeSection.id === 'section-inicio';
        const colClass = isHomeSection ? 'col' : 'movable-card-wrapper';
        
        const newCol = document.createElement('div');
        newCol.className = colClass;
        
        const newCard = document.createElement('div');
        newCard.className = textColor === 'white' ? 'card text-white h-100' : 'card h-100';
        newCard.style.backgroundColor = color;
        newCard.dataset.cardLink = link || '';
        
        if (isRestricted) {
            newCard.classList.add('restricted');
        }

        if (!isHomeSection) {
            const movableElements = cardsRow.querySelectorAll('.movable-card-wrapper');
            let maxTop = 0;
            if (movableElements.length > 0) {
                 movableElements.forEach(el => {
                    const top = parseFloat(el.style.top.replace('px', '')) || 0;
                    const height = el.offsetHeight || 0;
                    maxTop = Math.max(maxTop, top + height);
                });
            } else {
                maxTop = 0;
            }
            newCol.style.position = 'absolute';
            newCol.style.top = `${maxTop + 20}px`; 
            newCol.style.left = '0px';
            newCol.style.width = '48%';
            newCol.style.minHeight = '150px';
        }
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';
        
        const cardIcon = document.createElement('i');
        cardIcon.className = `fas ${icon} card-icon`;
        
        const cardTitle = document.createElement('h5');
        cardTitle.className = 'card-title editable-text';
        cardTitle.textContent = title;
        cardTitle.style.color = textColor;

        const cardText = document.createElement('p');
        cardText.className = 'card-text editable-text';
        cardText.textContent = description;
        cardText.style.color = textColor;

        cardBody.appendChild(cardIcon);
        cardBody.appendChild(cardTitle);
        cardBody.appendChild(cardText);
        newCard.appendChild(cardBody);
        
        if (isRestricted) {
            const restrictedOverlay = document.createElement('div');
            restrictedOverlay.className = 'restricted-overlay';
            restrictedOverlay.innerHTML = `
                <i class="fas fa-lock"></i>
                <span>Inicia sesión para acceder</span>
            `;
            newCard.appendChild(restrictedOverlay);
        }
        
        newCol.appendChild(newCard);
        cardsRow.appendChild(newCol);
        
        if (isEditMode) {
             if (!isHomeSection) {
                 makeElementDraggableAndResizable(newCol);
             }

             // CORRECCIÓN: Mejor manejo de la selección para tarjetas personalizadas
             if (activeEditable) {
                activeEditable.classList.remove('active-editable');
                const prevMovable = activeEditable.closest('.movable, .movable-card-wrapper');
                if (prevMovable) setMovableTextEditMode(prevMovable, false);
            }
             
             // Marcar los elementos como editables pero sin activar el modo de edición inmediatamente
             newCard.classList.add('active-editable');
             cardTitle.classList.add('active-editable');
             cardText.classList.add('active-editable');
             
             updateContentHeight();
             updatePositionInputs();
             
             saveAction({
                 type: 'addCard',
                 element: newCol.outerHTML,
                 container: cardsRow.id || cardsRow.className,
                 undo: function() {
                     newCol.remove();
                     updateContentHeight();
                 },
                 redo: function() {
                     cardsRow.appendChild(newCol);
                     if (!isHomeSection) {
                         makeElementDraggableAndResizable(newCol);
                     }
                     updateContentHeight();
                 }
             });
        }
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('cardCustomizationModal'));
        modal.hide();
    }

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : {r: 0, g: 0, b: 0};
    }

    // --- FUNCIONES MEJORADAS DE ELIMINACIÓN ---
    function deleteSelectedElement() {
      if (activeEditable) {
        const elementToDelete = activeEditable;
        const parentElement = elementToDelete.parentElement;
        
        const elementCopy = elementToDelete.cloneNode(true);
        
        const actionInfo = {
            type: 'deleteElement',
            element: elementCopy.outerHTML,
            parent: parentElement.outerHTML.substring(0, 100),
            elementId: elementToDelete.id || '',
            elementClass: elementToDelete.className,
            undo: function() {
                if (parentElement) {
                    parentElement.appendChild(elementCopy);
                    if (isEditMode) {
                        if (elementCopy.classList.contains('movable') || elementCopy.classList.contains('movable-card-wrapper')) {
                            makeElementDraggableAndResizable(elementCopy);
                        }
                    }
                    updateContentHeight();
                }
            },
            redo: function() {
                if (elementCopy.parentElement) {
                    elementCopy.remove();
                    updateContentHeight();
                }
            }
        };
        
        elementToDelete.remove();
        activeEditable = null;
        updatePositionInputs();
        
        // CORRECCIÓN: Llamar a updateContentHeight después de un breve delay
        setTimeout(updateContentHeight, 10);
        
        saveAction(actionInfo);
        
      } else {
        alert("Seleccione primero un elemento para eliminar.");
      }
    }

    function deleteSelectedCard() {
      if (activeEditable) {
        const card = activeEditable.closest('.card');
        if (card) {
          const cardWrapper = card.closest('.col, .movable-card-wrapper');
          if (cardWrapper) {
            const cardCopy = cardWrapper.cloneNode(true);
            
            const actionInfo = {
                type: 'deleteCard',
                element: cardCopy.outerHTML,
                parent: cardWrapper.parentElement.id || cardWrapper.parentElement.className,
                undo: function() {
                    if (cardWrapper.parentElement) {
                        cardWrapper.parentElement.appendChild(cardCopy);
                        if (isEditMode) {
                            if (cardCopy.classList.contains('movable-card-wrapper')) {
                                makeElementDraggableAndResizable(cardCopy);
                            }
                        }
                        updateContentHeight();
                    }
                },
                redo: function() {
                    if (cardCopy.parentElement) {
                        cardCopy.remove();
                        updateContentHeight();
                    }
                }
            };
            
            cardWrapper.remove();
            activeEditable = null;
            updatePositionInputs();
            
            // CORRECCIÓN: Llamar a updateContentHeight después de un breve delay
            setTimeout(updateContentHeight, 10);
            
            saveAction(actionInfo);
          }
        } else {
          alert("Seleccione primero una tarjeta para eliminar.");
        }
      } else {
        alert("Seleccione primero una tarjeta para eliminar.");
      }
    }

    // --- Teclas de acceso rápido ---
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Delete' && isEditMode && activeEditable) {
            e.preventDefault();
            deleteSelectedElement();
        }
        
        if (e.ctrlKey && e.key === 'z' && isEditMode) {
            e.preventDefault();
            undoAction();
        }
        
        if (e.ctrlKey && e.key === 'y' && isEditMode) {
            e.preventDefault();
            redoAction();
        }
        
        const target = activeEditable ? activeEditable.closest('.movable, .movable-card-wrapper') : null;
        if (!isEditMode || !target) return;
        
        if (activeEditable.getAttribute('contenteditable') === 'true' && document.activeElement === activeEditable) return; 

        let currentLeft = parseFloat(target.style.left.replace('px', '')) || 0;
        let currentTop = parseFloat(target.style.top.replace('px', '')) || 0;
        let moved = false;

        switch (e.key) {
            case 'ArrowUp': currentTop -= MOVE_STEP; moved = true; break;
            case 'ArrowDown': currentTop += MOVE_STEP; moved = true; break;
            case 'ArrowLeft': currentLeft -= MOVE_STEP; moved = true; break;
            case 'ArrowRight': currentLeft += MOVE_STEP; moved = true; break;
        }

        if (moved) {
            e.preventDefault();
            
            currentLeft = Math.max(0, currentLeft);
            currentTop = Math.max(0, currentTop);
            
            target.style.left = `${currentLeft}px`;
            target.style.top = `${currentTop}px`;
            
            updatePositionInputs();
            updateContentHeight();
        }
    });

    // --- Lógica de Clic y Selección CORREGIDA para tarjetas personalizadas ---
    let lastClickTime = 0;
    let clickCount = 0;
    let isEditingText = false;

    document.addEventListener('click', function(e) {
      if (!isEditMode) {
          const card = e.target.closest('.card');
          if (card) {
               const link = card.dataset.cardLink;
               if (link) {
                   e.preventDefault();
                   e.stopPropagation();
                   navigateToCardLink(link);
               }
          }
          return;
      }
      
      const el = e.target.closest('.editable-text');
      const card = e.target.closest('.card'); 
      const cardWrapper = e.target.closest('.movable-card-wrapper');
      
      if (e.target.closest('#editSidebar')) return;

      const now = new Date().getTime();
      const timeDiff = now - lastClickTime;

      // CORRECCIÓN: Manejo mejorado para evitar que se pierda la selección
      if (activeEditable && activeEditable !== el) {
          const activeMovable = activeEditable.closest('.movable, .movable-card-wrapper');
          if (activeMovable && activeMovable !== e.target.closest('.movable, .movable-card-wrapper')) {
              // Solo desactivar si no estamos en medio de una edición de texto
              if (!isEditingText) {
                  setMovableTextEditMode(activeMovable, false);
              }
          }
      }
      
      // Manejo de enlaces de tarjetas
      if (card && !el) {
          e.stopPropagation();
          e.preventDefault();
          
          const currentLink = card.dataset.cardLink || '';
          const newLink = prompt("Introduce la URL o la ID de sección (#metas) para esta tarjeta:", currentLink);
          
          if (newLink !== null) { 
              card.dataset.cardLink = newLink.trim();
              if (newLink.trim() === '') {
                   card.classList.remove('active-editable');
              } else {
                   card.classList.add('active-editable'); 
                   alert(`Enlace guardado: ${newLink}`);
              }
          }
          
          if (activeEditable && !isEditingText) {
            activeEditable.classList.remove('active-editable');
            activeEditable = null;
          }
          updatePositionInputs();
          return;
      }
      
      // Manejo de clics en elementos editables
      if (el && activeEditable === el) {
          if (timeDiff < 300) { clickCount++; } else { clickCount = 1; }
      } else { clickCount = 1; }
      lastClickTime = now;

      // CORRECCIÓN: Manejo mejorado del doble clic
      if (el && clickCount >= 2) {
          e.preventDefault();
          e.stopPropagation();
          isEditingText = true;
          const targetMovable = el.closest('.movable, .movable-card-wrapper');
          if (targetMovable) { 
              setMovableTextEditMode(targetMovable, true); 
          } else { 
              el.setAttribute('contenteditable', 'true'); 
          }
          el.focus();
          clickCount = 0;
          return;
      }

      // CORRECCIÓN: Selección normal sin interrumpir la edición
      if (el && !isEditingText) {
        e.stopPropagation();

        if (activeEditable && activeEditable !== el) {
            activeEditable.classList.remove('active-editable');
        }
        
        document.querySelectorAll('.card.active-editable').forEach(c => {
             const cardLink = c.dataset.cardLink;
             if (!cardLink || cardLink.trim() === '') c.classList.remove('active-editable');
        });

        activeEditable = el;
        activeEditable.classList.add('active-editable');

        if (cardWrapper && cardWrapper.getAttribute('contenteditable') !== 'true') {
            setMovableTextEditMode(cardWrapper, false);
        }

        updatePositionInputs();
      } else if (!e.target.closest('.movable, .movable-card-wrapper') && !isEditingText) {
        if (activeEditable) {
            activeEditable.classList.remove('active-editable');
            const targetMovable = activeEditable.closest('.movable, .movable-card-wrapper');
            if (targetMovable) setMovableTextEditMode(targetMovable, false); 
            activeEditable = null;
            updatePositionInputs();
        }
        document.querySelectorAll('.card.active-editable').forEach(c => {
             const cardLink = c.dataset.cardLink;
             if (!cardLink || cardLink.trim() === '') c.classList.remove('active-editable');
        });
      }
    });

    document.addEventListener('dblclick', function(e) {
        if (!isEditMode) return;
        const el = e.target.closest('.editable-text');
        if (el) {
            e.preventDefault();
            isEditingText = true;
            const targetMovable = el.closest('.movable, .movable-card-wrapper');
            if (targetMovable) { 
                setMovableTextEditMode(targetMovable, true); 
            } else { 
                el.setAttribute('contenteditable', 'true'); 
            }
            el.focus();
        }
    });

    // CORRECCIÓN: Manejo mejorado del focusout
    document.addEventListener('focusout', function(e) {
        if (!isEditMode) return;
        const el = e.target;

        if (el && el.classList.contains('editable-text') && el.getAttribute('contenteditable') === 'true') {
            setTimeout(() => {
                const newFocus = document.activeElement;
                const sidebar = document.getElementById('editSidebar');
                const isSelectingFont = newFocus && newFocus.id === 'fontFamilySelect'; 
                const targetMovable = el.closest('.movable, .movable-card-wrapper');

                if (!sidebar.contains(newFocus) || isSelectingFont) {
                    if (targetMovable) { 
                        setMovableTextEditMode(targetMovable, false); 
                    } else { 
                        el.removeAttribute('contenteditable'); 
                    }
                    isEditingText = false;
                } else {
                    el.focus(); 
                    restoreSelection();
                }
            }, 100);
        }
    });

    // CORRECCIÓN: Manejo de eventos de teclado para mantener la selección
    document.addEventListener('keydown', function(e) {
        if (isEditingText && (e.key === 'Escape' || (e.ctrlKey && e.key === 's'))) {
            e.preventDefault();
            const el = document.activeElement;
            if (el && el.classList.contains('editable-text')) {
                const targetMovable = el.closest('.movable, .movable-card-wrapper');
                if (targetMovable) {
                    setMovableTextEditMode(targetMovable, false);
                } else {
                    el.removeAttribute('contenteditable');
                }
                isEditingText = false;
                el.blur();
            }
        }
    });

    // --- Lógica de Modo Edición y Login ---
    function unwrapCard(card) {
        const link = card.closest('.card-link');
        if (link && link.tagName === 'A') {
            const wrapper = link.closest('.col') || link.closest('.col-half') || link.closest('.movable-card-wrapper');
            if (wrapper) {
                 wrapper.insertBefore(card, link);
                 link.remove();
            }
        }
    }

    function wrapCardWithLink(card, url) {
        const wrapper = card.closest('.col') || card.closest('.col-half') || card.closest('.movable-card-wrapper');
        if (!wrapper) return;
        
        const existingLink = wrapper.querySelector('.card-link');
        if (existingLink) {
             existingLink.setAttribute('href', url);
        } else {
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('target', url.startsWith('#') ? '_self' : '_blank'); 
            link.className = 'card-link'; 
            
            wrapper.insertBefore(link, card);
            link.appendChild(card);
        }
    }

    function toggleEditMode() {
      if (!isLoggedIn) {
          alert("Debes iniciar sesión con una cuenta de Administrador para acceder al Modo Edición.");
          return;
      }
      isEditMode = !isEditMode;
      const allEditables = document.querySelectorAll('.editable-text');
      const cards = document.querySelectorAll('.card');
      const editButton = document.getElementById('editToggleBtn');
      const sidebar = document.getElementById('editSidebar');
      const mainContentWrapper = document.getElementById('mainContentWrapper');

      if (isEditMode) {
        editButton.classList.replace('btn-outline-light', 'btn-light');
        editButton.innerHTML = '<i class="fas fa-save me-1"></i> Guardar Cambios';
        
        const editIndicator = document.createElement('div');
        editIndicator.className = 'edit-mode-indicator';
        editIndicator.id = 'editModeIndicator';
        editIndicator.innerHTML = '<i class="fas fa-edit me-1"></i> Modo Edición Activo';
        document.body.appendChild(editIndicator);
        
        allEditables.forEach(el => el.classList.add('active-editable'));

        cards.forEach(card => {
             unwrapCard(card);
             if (card.dataset.cardLink && card.dataset.cardLink.trim() !== '') {
                 card.classList.add('active-editable');
             }
        });
        
        sidebar.classList.remove('d-none-temp');
        mainContentWrapper.style.marginLeft = 'min(300px, 85vw)';
        
        initializeMovableElements();
        updateContentHeight();

      } else {
        editButton.classList.replace('btn-light', 'btn-outline-light');
        editButton.innerHTML = '<i class="fas fa-edit me-1"></i> Modo Edición';
        
        const editIndicator = document.getElementById('editModeIndicator');
        if (editIndicator) editIndicator.remove();
        
        allEditables.forEach(el => {
            el.removeAttribute('contenteditable');
            el.classList.remove('active-editable');
        });
        
        initializeMovableElements(); 

        cards.forEach(card => {
            card.classList.remove('active-editable');
            const link = card.dataset.cardLink;
            if (link && link.trim() !== '') {
                wrapCardWithLink(card, link);
            }
        });

        if (activeEditable) activeEditable.classList.remove('active-editable');
        activeEditable = null;
        savedRange = null; 
        isEditingText = false;
        updatePositionInputs();
        
        sidebar.classList.add('d-none-temp');
        mainContentWrapper.style.marginLeft = '0';
        document.getElementById('mainContent').style.minHeight = 'auto';
        
        saveToLocalStorage();
      }
    }

    function handleLogin() {
      const emailInput = document.getElementById('inputEmail').value;
      const passwordInput = document.getElementById('inputPassword').value;
      if (emailInput === 'a@ug.com' && passwordInput === '1234') {
        isLoggedIn = true;
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        document.getElementById('loginBtnContainer').classList.add('d-none');
        document.getElementById('userNav').classList.remove('d-none');
        document.getElementById('userNameDisplay').textContent = 'Administrador Daule';
        
        document.querySelectorAll('.restricted-nav').forEach(el => {
            el.classList.remove('restricted-nav');
            el.querySelector('.fa-lock').classList.add('d-none');
        });
        
        document.querySelectorAll('.card.restricted').forEach(card => {
            card.classList.remove('restricted');
        });
        
        loadFromLocalStorage();

      } else {
          alert("Credenciales incorrectas. Inténtalo de nuevo.");
      }
    }
    
    function handleLogout() {
      if (isEditMode) toggleEditMode();
      isLoggedIn = false;
      document.getElementById('userNav').classList.add('d-none');
      document.getElementById('loginBtnContainer').classList.remove('d-none');

      document.querySelectorAll('.navbar-nav .nav-item a').forEach(el => {
          const sectionId = el.getAttribute('onclick').match(/'(.*?)'/)[1];
          if (RESTRICTED_SECTIONS.includes(sectionId)) {
               el.classList.add('restricted-nav');
               el.querySelector('.fa-lock').classList.remove('d-none');
          }
      });
      
      document.querySelectorAll('.card').forEach(card => {
          const link = card.dataset.cardLink;
          if (link && RESTRICTED_SECTIONS.includes(link.substring(1))) {
              card.classList.add('restricted');
          }
      });
      
      showSection('inicio');
    }

    // Inicialización al cargar la página 
    document.addEventListener('DOMContentLoaded', () => {
        showSection('inicio'); 
        addToNavigationHistory('inicio');
        
        if (isTouchDevice) {
            document.body.classList.add('touch-device');
        }
        
        const savedData = localStorage.getItem('wasteManagementSystem');
        if (savedData) {
            const data = JSON.parse(savedData);
            if (data.content) {
                // Datos guardados disponibles
            }
        }
    });

    // --- Sistema de Historial de Acciones ---
    function saveAction(action) {
      if (currentHistoryIndex < actionHistory.length - 1) {
        actionHistory = actionHistory.slice(0, currentHistoryIndex + 1);
      }
      
      actionHistory.push(action);
      currentHistoryIndex = actionHistory.length - 1;
      
      if (actionHistory.length > MAX_HISTORY_SIZE) {
        actionHistory.shift();
        currentHistoryIndex--;
      }
      
      saveToLocalStorage();
    }
    
    function undoAction() {
      if (currentHistoryIndex >= 0) {
        const action = actionHistory[currentHistoryIndex];
        if (action && action.undo) {
          action.undo();
          currentHistoryIndex--;
          saveToLocalStorage();
        }
      }
    }
    
    function redoAction() {
      if (currentHistoryIndex < actionHistory.length - 1) {
        currentHistoryIndex++;
        const action = actionHistory[currentHistoryIndex];
        if (action && action.redo) {
          action.redo();
          saveToLocalStorage();
        }
      }
    }

    // --- Sistema de Navegación ---
    function addToNavigationHistory(sectionId) {
      if (currentNavigationIndex < navigationHistory.length - 1) {
        navigationHistory = navigationHistory.slice(0, currentNavigationIndex + 1);
      }
      
      navigationHistory.push(sectionId);
      currentNavigationIndex = navigationHistory.length - 1;
      
      if (navigationHistory.length > 20) {
        navigationHistory.shift();
        currentNavigationIndex--;
      }
    }
    
    function navigateBack() {
      if (currentNavigationIndex > 0) {
        currentNavigationIndex--;
        const sectionId = navigationHistory[currentNavigationIndex];
        showSection(sectionId, false);
      }
    }
    
    function navigateForward() {
      if (currentNavigationIndex < navigationHistory.length - 1) {
        currentNavigationIndex++;
        const sectionId = navigationHistory[currentNavigationIndex];
        showSection(sectionId, false);
      }
    }

    // --- Sistema de localStorage ---
    function saveToLocalStorage() {
      if (!isLoggedIn) return;
      
      const saveData = {
        content: document.getElementById('mainContent').innerHTML,
        actionHistory: actionHistory,
        currentHistoryIndex: currentHistoryIndex,
        navigationHistory: navigationHistory,
        currentNavigationIndex: currentNavigationIndex
      };
      
      localStorage.setItem('wasteManagementSystem', JSON.stringify(saveData));
    }
    
    function loadFromLocalStorage() {
      const savedData = localStorage.getItem('wasteManagementSystem');
      if (savedData) {
        const data = JSON.parse(savedData);
        
        if (data.content) {
          document.getElementById('mainContent').innerHTML = data.content;
        }
        
        if (data.actionHistory) {
          actionHistory = data.actionHistory;
          currentHistoryIndex = data.currentHistoryIndex || -1;
        }
        
        if (data.navigationHistory) {
          navigationHistory = data.navigationHistory;
          currentNavigationIndex = data.currentNavigationIndex || -1;
        }
        
        initializeMovableElements();
        // Actualizar altura después de cargar
        setTimeout(updateContentHeight, 100);
      }
    }

    // --- DASHBOARD PROAMBIENTAL ---
    function initProambientalDashboard() {
      (async function(){
        // ---------- CONFIGURACIÓN ----------
        const SUPABASE_URL = "https://dutapywxsiuxboqsjqvf.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1dGFweXd4c2l1eGJvcXNqcXZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MTk1MTUsImV4cCI6MjA2OTI5NTUxNX0.SBIDeV_WAWlyLs-ROD1ibXtqqY5bbbh0gouY8gRB9Y4";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ---------- SELECTORES ----------
        const selectEstadoCivil = document.getElementById('selectEstadoCivil');
        const selectEducacion = document.getElementById('selectEducacion');
        const selectSituacionLaboral = document.getElementById('selectSituacionLaboral');
        const selectIngreso = document.getElementById('selectIngreso');

        // Elementos de información de filtros
        const estadoCivilInfo = document.getElementById('estadoCivilInfo');
        const educacionInfo = document.getElementById('educacionInfo');
        const situacionLaboralInfo = document.getElementById('situacionLaboralInfo');
        const ingresoInfo = document.getElementById('ingresoInfo');

        // Elementos de resumen
        const summaryTotal = document.getElementById('summaryTotal');
        const summaryHogar = document.getElementById('summaryHogar');
        const summaryEducacion = document.getElementById('summaryEducacion');
        const summaryLaboral = document.getElementById('summaryLaboral');
        const summaryHogarChange = document.getElementById('summaryHogarChange');
        const summaryEducacionChange = document.getElementById('summaryEducacionChange');
        const summaryLaboralChange = document.getElementById('summaryLaboralChange');

        // Variables globales para datos
        let currentData = [];
        let allData = [];
        let filterOptions = {
          estadosCiviles: [],
          nivelesEducacion: [],
          situacionesLaborales: [],
          nivelesIngreso: []
        };

        // Variables para control de gráficos
        let currentChartType = 'pie';

        // Inicializar la aplicación
        async function initApp() {
          await cargarTodosLosDatos();
          await inicializarFiltros();
          await actualizar();
          setupEventListeners();
        }

        // Configurar event listeners
        function setupEventListeners() {
          // Actualización automática al cambiar filtros
          selectEstadoCivil.addEventListener('change', async function() {
            await actualizar();
          });
          
          selectEducacion.addEventListener('change', async function() {
            await actualizar();
          });
          
          selectSituacionLaboral.addEventListener('change', async function() {
            await actualizar();
          });
          
          selectIngreso.addEventListener('change', async function() {
            await actualizar();
          });
          
          // Cambiar tipo de gráfico
          document.querySelectorAll('.chart-action-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              // Remover clase activa de todos los botones
              document.querySelectorAll('.chart-action-btn').forEach(b => {
                b.classList.remove('active');
              });
              
              // Agregar clase activa al botón seleccionado
              this.classList.add('active');
              
              // Cambiar tipo de gráfico
              currentChartType = this.getAttribute('data-chart-type');
              actualizarGraficos();
            });
          });
          
          // Manejar pestañas
          document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
              const tabId = tab.getAttribute('data-tab');
              
              // Actualizar pestañas activas
              document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
              
              tab.classList.add('active');
              document.getElementById(tabId).classList.add('active');
              
              // Renderizar gráficos específicos si es necesario
              if (tabId === 'sociocultural') {
                renderSocioculturalCharts();
              } else if (tabId === 'afectivos') {
                renderAfectivosCharts();
              } else if (tabId === 'cognitivos') {
                renderCognitivosCharts();
              } else if (tabId === 'ambiental') {
                renderAmbientalCharts();
              } else if (tabId === 'economica') {
                renderEconomicaCharts();
              } else if (tabId === 'comunitario') {
                renderComunitarioCharts();
              }
            });
          });
        }

        // Cargar todos los datos para análisis
        async function cargarTodosLosDatos() {
          const q = await supabase.from('cuestionario_comportamiento_proambiental_autosustentabilidad').select('*');
          if (q.error) {
            console.error(q.error);
            return;
          }
          allData = q.data || [];
        }

        // Cargar lista de filtros desde la BD
        async function inicializarFiltros() {
          // Obtener todos los datos para construir los filtros
          const q = await supabase.from('cuestionario_comportamiento_proambiental_autosustentabilidad').select('estado_civil, educacion_jefe_hogar, situacion_laboral_jefe_hogar, ingreso_mensual_jefe_hogar');
          if (q.error) {
            console.error(q.error);
            return;
          }
          const rows = q.data || [];

          // Construir opciones de filtro
          filterOptions.estadosCiviles = [...new Set(rows.map(r => r.estado_civil).filter(Boolean))].sort();
          filterOptions.nivelesEducacion = [...new Set(rows.map(r => r.educacion_jefe_hogar).filter(Boolean))].sort();
          filterOptions.situacionesLaborales = [...new Set(rows.map(r => r.situacion_laboral_jefe_hogar).filter(Boolean))].sort();
          filterOptions.nivelesIngreso = [...new Set(rows.map(r => r.ingreso_mensual_jefe_hogar).filter(Boolean))].sort();

          // Actualizar información de filtros
          estadoCivilInfo.textContent = `${filterOptions.estadosCiviles.length} estados civiles disponibles`;
          educacionInfo.textContent = `${filterOptions.nivelesEducacion.length} niveles educativos disponibles`;
          situacionLaboralInfo.textContent = `${filterOptions.situacionesLaborales.length} situaciones laborales disponibles`;
          ingresoInfo.textContent = `${filterOptions.nivelesIngreso.length} niveles de ingreso disponibles`;

          // Llenar selectores con todas las opciones iniciales
          llenarSelector(selectEstadoCivil, filterOptions.estadosCiviles);
          llenarSelector(selectEducacion, filterOptions.nivelesEducacion);
          llenarSelector(selectSituacionLaboral, filterOptions.situacionesLaborales);
          llenarSelector(selectIngreso, filterOptions.nivelesIngreso);
        }

        // Función para llenar un selector con opciones
        function llenarSelector(selector, opciones) {
          // Guardar la opción seleccionada actualmente
          const valorActual = selector.value;
          
          // Limpiar selector (excepto la primera opción)
          while (selector.options.length > 1) {
            selector.remove(1);
          }
          
          // Agregar nuevas opciones
          opciones.forEach(opcion => {
            const option = document.createElement('option');
            option.value = opcion;
            option.textContent = opcion;
            selector.appendChild(option);
          });
          
          // Restaurar la selección anterior si todavía existe
          if (valorActual && opciones.includes(valorActual)) {
            selector.value = valorActual;
          }
        }

        // Construir query según filtros y traer datos
        async function obtenerFiltrados() {
          let q = supabase.from('cuestionario_comportamiento_proambiental_autosustentabilidad').select('*');
          if (selectEstadoCivil.value) q = q.eq('estado_civil', selectEstadoCivil.value);
          if (selectEducacion.value) q = q.eq('educacion_jefe_hogar', selectEducacion.value);
          if (selectSituacionLaboral.value) q = q.eq('situacion_laboral_jefe_hogar', selectSituacionLaboral.value);
          if (selectIngreso.value) q = q.eq('ingreso_mensual_jefe_hogar', selectIngreso.value);
          
          const r = await q;
          if (r.error) {
            console.error(r.error);
            return [];
          }
          return r.data || [];
        }

        // Calcular distribuciones para diferentes categorías
        function calcularDistribuciones(rows) {
          // Distribución por estado civil
          const estadoCivilCounts = {};
          rows.forEach(row => {
            if (row.estado_civil) {
              estadoCivilCounts[row.estado_civil] = (estadoCivilCounts[row.estado_civil] || 0) + 1;
            }
          });
          const totalEstadoCivil = Object.values(estadoCivilCounts).reduce((a, b) => a + b, 0);
          const estadoCivil = {};
          Object.keys(estadoCivilCounts).forEach(key => {
            estadoCivil[key] = totalEstadoCivil > 0 ? (estadoCivilCounts[key] / totalEstadoCivil) * 100 : 0;
          });
          
          // Distribución por edades - contar filas con valores > 0
          const age0_10 = rows.filter(row => row.edad_0_10 > 0).length;
          const age11_25 = rows.filter(row => row.edad_11_25 > 0).length;
          const age26_50 = rows.filter(row => row.edad_26_50 > 0).length;
          const age51_90 = rows.filter(row => row.edad_51_90 > 0).length;
          const totalAge = age0_10 + age11_25 + age26_50 + age51_90;
          
          const edad = {
            '0-10 años': totalAge > 0 ? (age0_10 / totalAge) * 100 : 0,
            '11-25 años': totalAge > 0 ? (age11_25 / totalAge) * 100 : 0,
            '26-50 años': totalAge > 0 ? (age26_50 / totalAge) * 100 : 0,
            '51-90 años': totalAge > 0 ? (age51_90 / totalAge) * 100 : 0
          };
          
          // Distribución por educación
          const educacionCounts = {};
          rows.forEach(row => {
            if (row.educacion_jefe_hogar) {
              educacionCounts[row.educacion_jefe_hogar] = (educacionCounts[row.educacion_jefe_hogar] || 0) + 1;
            }
          });
          const totalEducacion = Object.values(educacionCounts).reduce((a, b) => a + b, 0);
          const educacion = {};
          Object.keys(educacionCounts).forEach(key => {
            educacion[key] = totalEducacion > 0 ? (educacionCounts[key] / totalEducacion) * 100 : 0;
          });
          
          // Distribución por situación laboral
          const laboralCounts = {};
          rows.forEach(row => {
            if (row.situacion_laboral_jefe_hogar) {
              laboralCounts[row.situacion_laboral_jefe_hogar] = (laboralCounts[row.situacion_laboral_jefe_hogar] || 0) + 1;
            }
          });
          const totalLaboral = Object.values(laboralCounts).reduce((a, b) => a + b, 0);
          const laboral = {};
          Object.keys(laboralCounts).forEach(key => {
            laboral[key] = totalLaboral > 0 ? (laboralCounts[key] / totalLaboral) * 100 : 0;
          });
          
          // Distribución por ingreso
          const ingresoCounts = {};
          rows.forEach(row => {
            if (row.ingreso_mensual_jefe_hogar) {
              ingresoCounts[row.ingreso_mensual_jefe_hogar] = (ingresoCounts[row.ingreso_mensual_jefe_hogar] || 0) + 1;
            }
          });
          const totalIngreso = Object.values(ingresoCounts).reduce((a, b) => a + b, 0);
          const ingreso = {};
          Object.keys(ingresoCounts).forEach(key => {
            ingreso[key] = totalIngreso > 0 ? (ingresoCounts[key] / totalIngreso) * 100 : 0;
          });
          
          // Distribución por tipo de hogar
          const hogarCounts = {};
          rows.forEach(row => {
            if (row.tipo_hogar) {
              hogarCounts[row.tipo_hogar] = (hogarCounts[row.tipo_hogar] || 0) + 1;
            }
          });
          const totalHogar = Object.values(hogarCounts).reduce((a, b) => a + b, 0);
          const hogar = {};
          Object.keys(hogarCounts).forEach(key => {
            hogar[key] = totalHogar > 0 ? (hogarCounts[key] / totalHogar) * 100 : 0;
          });
          
          return {
            estadoCivil,
            edad,
            educacion,
            laboral,
            ingreso,
            hogar,
            counts: {
              estadoCivil: estadoCivilCounts,
              edad: { '0-10 años': age0_10, '11-25 años': age11_25, '26-50 años': age26_50, '51-90 años': age51_90 },
              educacion: educacionCounts,
              laboral: laboralCounts,
              ingreso: ingresoCounts,
              hogar: hogarCounts
            }
          };
        }

        // Calcular distribuciones para preguntas Likert
        function calcularDistribucionesLikert(rows) {
          // Definir todas las preguntas por categoría
          const categorias = {
            sociocultural: [
              'conoce_desechos_solidos',
              'cree_comportamiento_adecuado_manejo',
              'separar_desechos_por_origen',
              'clasificacion_correcta_desechos',
              'comportamiento_comunidad_influye',
              'dedica_tiempo_reducir_reutilizar_reciclar',
              'desechos_solidos_problema_comunidad'
            ],
            afectivos: [
              'preocupa_exceso_desechos',
              'desechos_contaminan_ambiente',
              'afecta_emocionalmente_noticias_contaminacion',
              'frustracion_falta_acciones_ambientales',
              'importancia_planeta_futuras_generaciones'
            ],
            cognitivos: [
              'consciente_impacto_desechos_salud',
              'investiga_temas_ambientales',
              'consecuencias_acumulacion_desechos',
              'beneficios_reutilizar_residuo',
              'falta_informacion_obstaculo_gestion'
            ],
            ambiental: [
              'desechos_organicos_funcionalidad',
              'acumulacion_desechos_afecta_salud',
              'reduccion_reciclaje_reutilizacion_cuida_ambiente',
              'transformacion_desechos_nuevos_productos',
              'necesita_info_educacion_ambiental'
            ],
            economica: [
              'practica_separacion_reciclaje_ingreso',
              'desechos_hogar_reutilizados',
              'manejo_adecuado_desechos_aporta_desarrollo',
              'emprendimientos_reutilizacion_aportan_economia',
              'manejo_adecuado_desechos_oportunidad_emprendimiento'
            ],
            comunitario: [
              'reducir_residuos_eventos_concientizacion',
              'participaria_talleres_buenas_practicas',
              'manejo_adecuado_desechos_impacto_ambiente',
              'dispuesto_participar_emprendimiento_desechos',
              'participaria_feria_emprendimientos_desechos'
            ]
          };
          
          const distribuciones = {};
          const promedios = {};
          
          // Para cada categoría, calcular distribuciones
          Object.keys(categorias).forEach(categoria => {
            distribuciones[categoria] = {};
            promedios[categoria] = {
              'Totalmente desacuerdo': 0,
              'Desacuerdo': 0,
              'Indiferente': 0,
              'De acuerdo': 0,
              'Totalmente de acuerdo': 0,
              'Promedio': 0
            };
            
            categorias[categoria].forEach(pregunta => {
              distribuciones[categoria][pregunta] = {
                'Totalmente desacuerdo': 0,
                'Desacuerdo': 0,
                'Indiferente': 0,
                'De acuerdo': 0,
                'Totalmente de acuerdo': 0,
                'Promedio': 0
              };
              
              rows.forEach(row => {
                const respuesta = row[pregunta];
                if (respuesta && distribuciones[categoria][pregunta][respuesta] !== undefined) {
                  distribuciones[categoria][pregunta][respuesta]++;
                }
              });
              
              // Calcular porcentajes y promedio
              const total = rows.length;
              let sumaPonderada = 0;
              Object.keys(distribuciones[categoria][pregunta]).forEach(respuesta => {
                if (respuesta !== 'Promedio') {
                  const porcentaje = (distribuciones[categoria][pregunta][respuesta] / total) * 100;
                  distribuciones[categoria][pregunta][respuesta] = porcentaje;
                  
                  // Calcular promedio ponderado (1-5)
                  const valor = {
                    'Totalmente desacuerdo': 1,
                    'Desacuerdo': 2,
                    'Indiferente': 3,
                    'De acuerdo': 4,
                    'Totalmente de acuerdo': 5
                  }[respuesta];
                  
                  sumaPonderada += valor * (distribuciones[categoria][pregunta][respuesta] / 100);
                }
              });
              
              distribuciones[categoria][pregunta]['Promedio'] = (sumaPonderada / 5) * 100;
              
              // Acumular para promedios generales
              Object.keys(promedios[categoria]).forEach(respuesta => {
                if (respuesta !== 'Promedio') {
                  promedios[categoria][respuesta] += distribuciones[categoria][pregunta][respuesta];
                }
              });
              promedios[categoria]['Promedio'] += distribuciones[categoria][pregunta]['Promedio'];
            });
            
            // Calcular promedios generales
            const numPreguntas = categorias[categoria].length;
            Object.keys(promedios[categoria]).forEach(respuesta => {
              promedios[categoria][respuesta] = promedios[categoria][respuesta] / numPreguntas;
            });
          });
          
          return { distribuciones, promedios };
        }

        // Renderizar gráficos demográficos
        function renderDemographicsCharts(distribuciones) {
          // Gráfico de estado civil
          renderDemographicChart('estadoCivilChart', 
            Object.keys(distribuciones.estadoCivil), 
            Object.values(distribuciones.estadoCivil),
            distribuciones.counts.estadoCivil,
            'Distribución por Estado Civil');
          
          // Gráfico de edades
          renderDemographicChart('edadChart', 
            Object.keys(distribuciones.edad), 
            Object.values(distribuciones.edad),
            distribuciones.counts.edad,
            'Distribución por Grupos de Edad');
          
          // Gráfico de educación
          renderDemographicChart('educacionChart', 
            Object.keys(distribuciones.educacion), 
            Object.values(distribuciones.educacion),
            distribuciones.counts.educacion,
            'Distribución por Nivel Educativo');
          
          // Gráfico de situación laboral
          renderDemographicChart('laboralChart', 
            Object.keys(distribuciones.laboral), 
            Object.values(distribuciones.laboral),
            distribuciones.counts.laboral,
            'Distribución por Situación Laboral');
          
          // Gráfico de ingreso
          renderDemographicChart('ingresoChart', 
            Object.keys(distribuciones.ingreso), 
            Object.values(distribuciones.ingreso),
            distribuciones.counts.ingreso,
            'Distribución por Ingreso Mensual');
          
          // Gráfico de tipo de hogar
          renderDemographicChart('hogarChart', 
            Object.keys(distribuciones.hogar), 
            Object.values(distribuciones.hogar),
            distribuciones.counts.hogar,
            'Distribución por Tipo de Hogar');
        }

        // Función para renderizar gráficos demográficos
        function renderDemographicChart(canvasId, labels, data, counts, title) {
          const ctx = document.getElementById(canvasId).getContext('2d');
          
          // Destruir gráfico existente si existe
          if (window[canvasId + 'Chart']) {
            window[canvasId + 'Chart'].destroy();
          }
          
          const colors = ['#4f46e5', '#0ea5e9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
          
          // Determinar tipo de gráfico según selección
          let chartType = currentChartType;
          
          // Configuración específica para cada tipo de gráfico
          let chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: chartType === 'pie' || chartType === 'doughnut',
                position: 'right'
              },
              title: {
                display: true,
                text: title,
                font: {
                  size: 14,
                  weight: 'bold'
                },
                padding: {
                  top: 10,
                  bottom: 20
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.parsed ? context.parsed.y : context.raw;
                    const count = counts[context.label] || 0;
                    return `${label}: ${value.toFixed(1)}% (${count} personas)`;
                  }
                }
              }
            }
          };
          
          // Configuración específica para gráficos de torta
          if (chartType === 'pie') {
            chartOptions.plugins.datalabels = {
              formatter: (value, ctx) => {
                // Si el valor es menor a 5%, mostrar la etiqueta fuera del gráfico
                if (value < 5) {
                  return null; // No mostrar porcentajes pequeños dentro del gráfico
                }
                return value.toFixed(1) + '%';
              },
              color: '#fff',
              font: {
                weight: 'bold',
                size: 12
              },
              textShadowBlur: 10,
              textShadowColor: 'rgba(0,0,0,0.8)'
            };
            
            // Añadir leyenda mejorada para mostrar todos los porcentajes
            chartOptions.plugins.legend = {
              display: true,
              position: 'right',
              labels: {
                generateLabels: function(chart) {
                  const data = chart.data;
                  if (data.labels.length && data.datasets.length) {
                    return data.labels.map((label, i) => {
                      const value = data.datasets[0].data[i];
                      return {
                        text: `${label}: ${value.toFixed(1)}%`,
                        fillStyle: data.datasets[0].backgroundColor[i],
                        strokeStyle: data.datasets[0].borderColor[i],
                        lineWidth: data.datasets[0].borderWidth,
                        hidden: false,
                        index: i
                      };
                    });
                  }
                  return [];
                }
              }
            };
          }
          
          // Configuración específica para gráficos de barras
          if (chartType === 'bar') {
            chartOptions.scales = {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: 'Porcentaje (%)'
                }
              }
            };
            chartOptions.plugins.datalabels = {
              formatter: function(value) {
                return value.toFixed(1) + '%';
              },
              color: '#1e293b',
              font: {
                weight: 'bold',
                size: 12
              },
              anchor: 'end',
              align: 'top'
            };
          }
          
          // Configuración específica para gráficos de líneas
          if (chartType === 'line') {
            chartOptions.scales = {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: 'Porcentaje (%)'
                },
                ticks: {
                  padding: 15 // Añadir espacio para evitar superposición
                }
              },
              x: {
                ticks: {
                  padding: 10 // Añadir espacio para evitar superposición
                }
              }
            };
            chartOptions.plugins.datalabels = {
              formatter: function(value) {
                return value.toFixed(1) + '%';
              },
              color: '#1e293b',
              font: {
                weight: 'bold',
                size: 12
              },
              align: 'top',
              offset: 8 // Añadir offset para evitar superposición
            };
          }
          
          window[canvasId + 'Chart'] = new Chart(ctx, {
            type: chartType,
            data: {
              labels: labels,
              datasets: [{
                label: 'Porcentaje (%)',
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderColor: colors.slice(0, labels.length).map(c => c.replace(')', ', 0.8)')),
                borderWidth: 1,
                fill: chartType === 'line' // Solo llenar para gráficos de línea
              }]
            },
            options: chartOptions,
            plugins: chartType === 'pie' || chartType === 'bar' || chartType === 'line' ? [ChartDataLabels] : []
          });
        }

        // Renderizar gráficos individuales para Determinantes Socioculturales
        function renderSocioculturalCharts() {
          if (!currentData.length) return;
          
          const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
          const preguntasSociocultural = [
            'conoce_desechos_solidos',
            'cree_comportamiento_adecuado_manejo',
            'separar_desechos_por_origen',
            'clasificacion_correcta_desechos',
            'comportamiento_comunidad_influye',
            'dedica_tiempo_reducir_reutilizar_reciclar',
            'desechos_solidos_problema_comunidad'
          ];
          
          const titulosSociocultural = [
            '¿Conoce usted qué son los desechos sólidos domiciliarios?',
            '¿Cree usted que existe un comportamiento adecuado en el manejo de los desechos sólidos domiciliarios en la comunidad?',
            '¿Se debe separar los desechos sólidos según su tipo ejemplo: (papel - plástico - orgánico - inorgánico)?',
            '¿Es importante la correcta clasificación de los desechos sólidos orgánicos e inorgánicos en el hogar?',
            '¿Cree que el comportamiento de la comunidad influye en deterioro del medio ambiente?',
            '¿Dedica tiempo para reducir, reutilizar y/o reciclar los desechos sólidos que se generan en el hogar?',
            '¿Los desechos sólidos son un gran problema para la comunidad?'
          ];
          
          preguntasSociocultural.forEach((pregunta, index) => {
            const canvasId = `socioculturalChart${index + 1}`;
            const titulo = titulosSociocultural[index];
            const datos = distribucionesLikert.sociocultural[pregunta];
            
            renderQuestionChart(canvasId, datos, titulo, currentData.length);
          });
        }

        // Renderizar gráficos individuales para Determinantes Afectivos
        function renderAfectivosCharts() {
          if (!currentData.length) return;
          
          const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
          const preguntasAfectivos = [
            'preocupa_exceso_desechos',
            'desechos_contaminan_ambiente',
            'afecta_emocionalmente_noticias_contaminacion',
            'frustracion_falta_acciones_ambientales',
            'importancia_planeta_futuras_generaciones'
          ];
          
          const titulosAfectivos = [
            '¿Le preocupa el exceso de desechos sólidos domiciliarios?',
            '¿Considera que los desechos sólidos domiciliarios intervienen en las consecuencias climáticas?',
            '¿Le afecta emocionalmente cuando escucha noticias acerca de los desastres naturales?',
            '¿Siente frustración debido a la falta de acciones significativas para abordar la generación de los desechos sólidos?',
            '¿Considera importante pensar en el tipo de planeta que dejaremos a las futuras generaciones?'
          ];
          
          preguntasAfectivos.forEach((pregunta, index) => {
            const canvasId = `afectivosChart${index + 1}`;
            const titulo = titulosAfectivos[index];
            const datos = distribucionesLikert.afectivos[pregunta];
            
            renderQuestionChart(canvasId, datos, titulo, currentData.length);
          });
        }

        // Renderizar gráficos individuales para Determinantes Cognitivos
        function renderCognitivosCharts() {
          if (!currentData.length) return;
          
          const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
          const preguntasCognitivos = [
            'consciente_impacto_desechos_salud',
            'investiga_temas_ambientales',
            'consecuencias_acumulacion_desechos',
            'beneficios_reutilizar_residuo',
            'falta_informacion_obstaculo_gestion'
          ];
          
          const titulosCognitivos = [
            '¿Es consciente del impacto de los desechos sólidos domiciliarios en el medio ambiente?',
            '¿Investiga frecuentemente acerca de temas medio ambientales?',
            '¿Conoce las consecuencias de la acumulación de los desechos sólidos domiciliarios?',
            '¿Conoce los beneficios de reutilizar un residuo domiciliario?',
            '¿La falta de información es un obstáculo para la correcta gestión de los residuos sólidos domiciliario?'
          ];
          
          preguntasCognitivos.forEach((pregunta, index) => {
            const canvasId = `cognitivosChart${index + 1}`;
            const titulo = titulosCognitivos[index];
            const datos = distribucionesLikert.cognitivos[pregunta];
            
            renderQuestionChart(canvasId, datos, titulo, currentData.length);
          });
        }

        // Renderizar gráficos individuales para Sustentabilidad Ambiental
        function renderAmbientalCharts() {
          if (!currentData.length) return;
          
          const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
          const preguntasAmbiental = [
            'desechos_organicos_funcionalidad',
            'acumulacion_desechos_afecta_salud',
            'reduccion_reciclaje_reutilizacion_cuida_ambiente',
            'transformacion_desechos_nuevos_productos',
            'necesita_info_educacion_ambiental'
          ];
          
          const titulosAmbiental = [
            '¿Los desechos orgánicos generados en el hogar pueden tener otra funcionalidad?',
            '¿La acumulación de desechos afectan a la salud de la población?',
            '¿La reducción, reciclaje y la reutilización de los desechos sólidos puede cuidar al medio ambiente y a la vida silvestre?',
            '¿Cree que la transformación de desechos sólidos en nuevos productos puede contribuir significativamente a la reducción de la generación de desechos?',
            '¿Necesita más información acerca de educación ambiental?'
          ];
          
          preguntasAmbiental.forEach((pregunta, index) => {
            const canvasId = `ambientalChart${index + 1}`;
            const titulo = titulosAmbiental[index];
            const datos = distribucionesLikert.ambiental[pregunta];
            
            renderQuestionChart(canvasId, datos, titulo, currentData.length);
          });
        }

        // Renderizar gráficos individuales para Sustentabilidad Económica
        function renderEconomicaCharts() {
          if (!currentData.length) return;
          
          const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
          const preguntasEconomica = [
            'practica_separacion_reciclaje_ingreso',
            'desechos_hogar_reutilizados',
            'manejo_adecuado_desechos_aporta_desarrollo',
            'emprendimientos_reutilizacion_aportan_economia',
            'manejo_adecuado_desechos_oportunidad_emprendimiento'
          ];
          
          const titulosEconomica = [
            '¿En su hogar practica la separación de los desechos para el reciclaje y le representa algún ingreso?',
            '¿Los desechos sólidos generados en el hogar pueden ser reutilizados para una nueva función o creación de un producto?',
            '¿Cree que el manejo adecuado de los desechos sólidos domiciliarios podría aportar al desarrollo económico comunitario?',
            '¿Los emprendimientos en base a la reutilización de los desechos aporta a su economía?',
            '¿El manejo adecuado de los desechos sólidos domiciliarios ofrece oportunidades para el emprendimiento?'
          ];
          
          preguntasEconomica.forEach((pregunta, index) => {
            const canvasId = `economicaChart${index + 1}`;
            const titulo = titulosEconomica[index];
            const datos = distribucionesLikert.economica[pregunta];
            
            renderQuestionChart(canvasId, datos, titulo, currentData.length);
          });
        }

        // Renderizar gráficos individuales para Desarrollo Comunitario
        function renderComunitarioCharts() {
          if (!currentData.length) return;
          
          const { distribuciones: distribucionesLikert } = calcularDistribucionesLikert(currentData);
          const preguntasComunitario = [
            'reducir_residuos_eventos_concientizacion',
            'participaria_talleres_buenas_practicas',
            'manejo_adecuado_desechos_impacto_ambiente',
            'dispuesto_participar_emprendimiento_desechos',
            'participaria_feria_emprendimientos_desechos'
          ];
          
          const titulosComunitario = [
            '¿Es posible reducir la generación de residuos sólidos domiciliarios por medio de eventos de concientización?',
            '¿Participaría en talleres de buenas prácticas y capacitaciones para el correcto manejo de los desechos sólidos domiciliarios?',
            '¿El manejo adecuado de los desechos sólidos domiciliarios puede tener un impacto significativo al medio ambiente?',
            '¿Está dispuesto a participar en un emprendimiento en base al uso de los desechos sólidos?',
            '¿Participaría a una feria de emprendimientos comunitarios en base a desechos domiciliarios reutilizados?'
          ];
          
          preguntasComunitario.forEach((pregunta, index) => {
            const canvasId = `comunitarioChart${index + 1}`;
            const titulo = titulosComunitario[index];
            const datos = distribucionesLikert.comunitario[pregunta];
            
            renderQuestionChart(canvasId, datos, titulo, currentData.length);
          });
        }

        // Función para renderizar gráficos individuales de preguntas
        function renderQuestionChart(canvasId, data, title, total) {
          const ctx = document.getElementById(canvasId).getContext('2d');
          
          // Destruir gráfico existente si existe
          if (window[canvasId + 'Chart']) {
            window[canvasId + 'Chart'].destroy();
          }
          
          const respuestas = ['Totalmente desacuerdo', 'Desacuerdo', 'Indiferente', 'De acuerdo', 'Totalmente de acuerdo'];
          const valores = respuestas.map(respuesta => data[respuesta]);
          const colors = ['#ef4444', '#f59e0b', '#64748b', '#0ea5e9', '#10b981'];
          
          // Calcular cantidades para cada respuesta
          const cantidades = respuestas.map(respuesta => Math.round((data[respuesta] / 100) * total));
          
          // Configuración específica para cada tipo de gráfico
          let chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: currentChartType === 'pie' || currentChartType === 'doughnut',
                position: 'right'
              },
              title: {
                display: true,
                text: title,
                font: {
                  size: 14,
                  weight: 'bold'
                },
                padding: {
                  top: 10,
                  bottom: 20
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.parsed ? context.parsed.y : context.raw;
                    const index = context.dataIndex;
                    const cantidad = cantidades[index];
                    return `${label}: ${value.toFixed(1)}% (${cantidad} personas)`;
                  }
                }
              }
            }
          };
          
          // Configuración específica para gráficos de torta
          if (currentChartType === 'pie') {
            chartOptions.plugins.datalabels = {
              formatter: (value, ctx) => {
                // Si el valor es menor a 5%, mostrar la etiqueta fuera del gráfico
                if (value < 5) {
                  return null; // No mostrar porcentajes pequeños dentro del gráfico
                }
                return value.toFixed(1) + '%';
              },
              color: '#fff',
              font: {
                weight: 'bold',
                size: 12
              },
              textShadowBlur: 10,
              textShadowColor: 'rgba(0,0,0,0.8)'
            };
            
            // Añadir leyenda mejorada para mostrar todos los porcentajes
            chartOptions.plugins.legend = {
              display: true,
              position: 'right',
              labels: {
                generateLabels: function(chart) {
                  const data = chart.data;
                  if (data.labels.length && data.datasets.length) {
                    return data.labels.map((label, i) => {
                      const value = data.datasets[0].data[i];
                      return {
                        text: `${label}: ${value.toFixed(1)}%`,
                        fillStyle: data.datasets[0].backgroundColor[i],
                        strokeStyle: data.datasets[0].borderColor[i],
                        lineWidth: data.datasets[0].borderWidth,
                        hidden: false,
                        index: i
                      };
                    });
                  }
                  return [];
                }
              }
            };
          }
          
          // Configuración específica para gráficos de barras
          if (currentChartType === 'bar') {
            chartOptions.scales = {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: 'Porcentaje (%)'
                }
              }
            };
            chartOptions.plugins.datalabels = {
              formatter: function(value) {
                return value.toFixed(1) + '%';
              },
              color: '#1e293b',
              font: {
                weight: 'bold',
                size: 12
              },
              anchor: 'end',
              align: 'top'
            };
          }
          
          // Configuración específica para gráficos de líneas
          if (currentChartType === 'line') {
            chartOptions.scales = {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: 'Porcentaje (%)'
                },
                ticks: {
                  padding: 15 // Añadir espacio para evitar superposición
                }
              },
              x: {
                ticks: {
                  padding: 10 // Añadir espacio para evitar superposición
                }
              }
            };
            chartOptions.plugins.datalabels = {
              formatter: function(value) {
                return value.toFixed(1) + '%';
              },
              color: '#1e293b',
              font: {
                weight: 'bold',
                size: 12
              },
              align: 'top',
              offset: 8 // Añadir offset para evitar superposición
            };
          }
          
          window[canvasId + 'Chart'] = new Chart(ctx, {
            type: currentChartType,
            data: {
              labels: respuestas,
              datasets: [{
                label: 'Porcentaje (%)',
                data: valores,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace(')', ', 0.8)')),
                borderWidth: 1,
                fill: currentChartType === 'line' // Solo llenar para gráficos de línea
              }]
            },
            options: chartOptions,
            plugins: currentChartType === 'pie' || currentChartType === 'bar' || currentChartType === 'line' ? [ChartDataLabels] : []
          });
        }

        // Llenar tablas resumen
        function llenarTablasResumen(distribuciones, distribucionesLikert) {
          // Tabla de estado civil
          llenarTablaCategoria('tablaEstadoCivil', distribuciones.estadoCivil, distribuciones.counts.estadoCivil, 'totalEstadoCivil');
          
          // Tabla de edades
          llenarTablaCategoria('tablaEdades', distribuciones.edad, distribuciones.counts.edad, 'totalEdades');
          
          // Tabla de educación
          llenarTablaCategoria('tablaEducacion', distribuciones.educacion, distribuciones.counts.educacion, 'totalEducacion');
          
          // Tabla de situación laboral
          llenarTablaCategoria('tablaLaboral', distribuciones.laboral, distribuciones.counts.laboral, 'totalLaboral');
          
          // Tabla de ingreso
          llenarTablaCategoria('tablaIngreso', distribuciones.ingreso, distribuciones.counts.ingreso, 'totalIngreso');
          
          // Tabla de tipo de hogar
          llenarTablaCategoria('tablaHogar', distribuciones.hogar, distribuciones.counts.hogar, 'totalHogar');
          
          // Tablas de determinantes Likert
          llenarTablaLikert('tablaSociocultural', distribucionesLikert.distribuciones.sociocultural, distribucionesLikert.promedios.sociocultural, 'sociocultural');
          llenarTablaLikert('tablaAfectivos', distribucionesLikert.distribuciones.afectivos, distribucionesLikert.promedios.afectivos, 'afectivos');
          llenarTablaLikert('tablaCognitivos', distribucionesLikert.distribuciones.cognitivos, distribucionesLikert.promedios.cognitivos, 'cognitivos');
          llenarTablaLikert('tablaAmbiental', distribucionesLikert.distribuciones.ambiental, distribucionesLikert.promedios.ambiental, 'ambiental');
          llenarTablaLikert('tablaEconomica', distribucionesLikert.distribuciones.economica, distribucionesLikert.promedios.economica, 'economica');
          llenarTablaLikert('tablaComunitario', distribucionesLikert.distribuciones.comunitario, distribucionesLikert.promedios.comunitario, 'comunitario');
        }

        // Función para llenar tablas de categorías
        function llenarTablaCategoria(tablaId, distribucion, counts, totalId) {
          const tbody = document.getElementById(tablaId);
          tbody.innerHTML = '';
          
          let totalCount = 0;
          
          Object.keys(distribucion).forEach(categoria => {
            const count = counts[categoria] || 0;
            totalCount += count;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${categoria}</td>
              <td style="text-align:right">${count}</td>
              <td style="text-align:right">${distribucion[categoria].toFixed(2)}%</td>
            `;
            tbody.appendChild(tr);
          });
          
          // Actualizar total
          document.getElementById(totalId).textContent = totalCount;
        }

        // Función para llenar tablas Likert
        function llenarTablaLikert(tablaId, distribucion, promedios, categoria) {
          const tbody = document.getElementById(tablaId);
          tbody.innerHTML = '';
          
          const respuestas = ['Totalmente desacuerdo', 'Desacuerdo', 'Indiferente', 'De acuerdo', 'Totalmente de acuerdo'];
          
          Object.keys(distribucion).forEach(pregunta => {
            const tr = document.createElement('tr');
            
            // Mapear pregunta a texto legible
            const preguntasMap = {
              'conoce_desechos_solidos': '¿Conoce usted qué son los desechos sólidos domiciliarios?',
              'cree_comportamiento_adecuado_manejo': '¿Cree usted que existe un comportamiento adecuado en el manejo de los desechos sólidos domiciliarios en la comunidad?',
              'separar_desechos_por_origen': '¿Se debe separar los desechos sólidos según su tipo ejemplo: (papel - plástico - orgánico - inorgánico)?',
              'clasificacion_correcta_desechos': '¿Es importante la correcta clasificación de los desechos sólidos orgánicos e inorgánicos en el hogar?',
              'comportamiento_comunidad_influye': '¿Cree que el comportamiento de la comunidad influye en deterioro del medio ambiente?',
              'dedica_tiempo_reducir_reutilizar_reciclar': '¿Dedica tiempo para reducir, reutilizar y/o reciclar los desechos sólidos que se generan en el hogar?',
              'desechos_solidos_problema_comunidad': '¿Los desechos sólidos son un gran problema para la comunidad?',
              'preocupa_exceso_desechos': '¿Le preocupa el exceso de desechos sólidos domiciliarios?',
              'desechos_contaminan_ambiente': '¿Considera que los desechos sólidos domiciliarios intervienen en las consecuencias climáticas?',
              'afecta_emocionalmente_noticias_contaminacion': '¿Le afecta emocionalmente cuando escucha noticias acerca de los desastres naturales?',
              'frustracion_falta_acciones_ambientales': '¿Siente frustración debido a la falta de acciones significativas para abordar la generación de los desechos sólidos?',
              'importancia_planeta_futuras_generaciones': '¿Considera importante pensar en el tipo de planeta que dejaremos a las futuras generaciones?',
              'consciente_impacto_desechos_salud': '¿Es consciente del impacto de los desechos sólidos domiciliarios en el medio ambiente?',
              'investiga_temas_ambientales': '¿Investiga frecuentemente acerca de temas medio ambientales?',
              'consecuencias_acumulacion_desechos': '¿Conoce las consecuencias de la acumulación de los desechos sólidos domiciliarios?',
              'beneficios_reutilizar_residuo': '¿Conoce los beneficios de reutilizar un residuo domiciliario?',
              'falta_informacion_obstaculo_gestion': '¿La falta de información es un obstáculo para la correcta gestión de los residuos sólidos domiciliario?',
              'desechos_organicos_funcionalidad': '¿Los desechos orgánicos generados en el hogar pueden tener otra funcionalidad?',
              'acumulacion_desechos_afecta_salud': '¿La acumulación de desechos afectan a la salud de la población?',
              'reduccion_reciclaje_reutilizacion_cuida_ambiente': '¿La reducción, reciclaje y la reutilización de los desechos sólidos puede cuidar al medio ambiente y a la vida silvestre?',
              'transformacion_desechos_nuevos_productos': '¿Cree que la transformación de desechos sólidos en nuevos productos puede contribuir significativamente a la reducción de la generación de desechos?',
              'necesita_info_educacion_ambiental': '¿Necesita más información acerca de educación ambiental?',
              'practica_separacion_reciclaje_ingreso': '¿En su hogar practica la separación de los desechos para el reciclaje y le representa algún ingreso?',
              'desechos_hogar_reutilizados': '¿Los desechos sólidos generados en el hogar pueden ser reutilizados para una nueva función o creación de un producto?',
              'manejo_adecuado_desechos_aporta_desarrollo': '¿Cree que el manejo adecuado de los desechos sólidos domiciliarios podría aportar al desarrollo económico comunitario?',
              'emprendimientos_reutilizacion_aportan_economia': '¿Los emprendimientos en base a la reutilización de los desechos aporta a su economía?',
              'manejo_adecuado_desechos_oportunidad_emprendimiento': '¿El manejo adecuado de los desechos sólidos domiciliarios ofrece oportunidades para el emprendimiento?',
              'reducir_residuos_eventos_concientizacion': '¿Es posible reducir la generación de residuos sólidos domiciliarios por medio de eventos de concientización?',
              'participaria_talleres_buenas_practicas': '¿Participaría en talleres de buenas prácticas y capacitaciones para el correcto manejo de los desechos sólidos domiciliarios?',
              'manejo_adecuado_desechos_impacto_ambiente': '¿El manejo adecuado de los desechos sólidos domiciliarios puede tener un impacto significativo al medio ambiente?',
              'dispuesto_participar_emprendimiento_desechos': '¿Está dispuesto a participar en un emprendimiento en base al uso de los desechos sólidos?',
              'participaria_feria_emprendimientos_desechos': '¿Participaría a una feria de emprendimientos comunitarios en base a desechos domiciliarios reutilizados?'
            };
            
            const preguntaTexto = preguntasMap[pregunta] || pregunta;
            
            let celdas = `<td>${preguntaTexto}</td>`;
            
            respuestas.forEach(respuesta => {
              celdas += `<td style="text-align:center">${distribucion[pregunta][respuesta].toFixed(1)}%</td>`;
            });
            
            celdas += `<td style="text-align:center"><strong>${distribucion[pregunta]['Promedio'].toFixed(1)}%</strong></td>`;
            
            tr.innerHTML = celdas;
            tbody.appendChild(tr);
          });
          
          // Actualizar promedios generales
          document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}TD`).textContent = promedios['Totalmente desacuerdo'].toFixed(1) + '%';
          document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}D`).textContent = promedios['Desacuerdo'].toFixed(1) + '%';
          document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}I`).textContent = promedios['Indiferente'].toFixed(1) + '%';
          document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}A`).textContent = promedios['De acuerdo'].toFixed(1) + '%';
          document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}TA`).textContent = promedios['Totalmente de acuerdo'].toFixed(1) + '%';
          document.getElementById(`promedio${categoria.charAt(0).toUpperCase() + categoria.slice(1)}`).textContent = promedios['Promedio'].toFixed(1) + '%';
        }

        // Actualizar resúmenes
        function actualizarResumenes(distribuciones) {
          const totalRecords = currentData.length;
          summaryTotal.textContent = totalRecords;
          
          // Encontrar categorías predominantes
          const hogarPredominante = Object.keys(distribuciones.hogar).reduce((a, b) => 
            distribuciones.hogar[a] > distribuciones.hogar[b] ? a : b, '');
          const hogarPorcentaje = distribuciones.hogar[hogarPredominante] || 0;
          
          const educacionPredominante = Object.keys(distribuciones.educacion).reduce((a, b) => 
            distribuciones.educacion[a] > distribuciones.educacion[b] ? a : b, '');
          const educacionPorcentaje = distribuciones.educacion[educacionPredominante] || 0;
          
          const laboralPredominante = Object.keys(distribuciones.laboral).reduce((a, b) => 
            distribuciones.laboral[a] > distribuciones.laboral[b] ? a : b, '');
          const laboralPorcentaje = distribuciones.laboral[laboralPredominante] || 0;
          
          // Actualizar tarjetas de resumen
          summaryHogar.textContent = hogarPredominante;
          summaryEducacion.textContent = educacionPredominante;
          summaryLaboral.textContent = laboralPredominante;
          
          // Actualizar resúmenes de porcentajes
          summaryHogarChange.innerHTML = `<span>${hogarPorcentaje.toFixed(1)}% del total</span>`;
          summaryEducacionChange.innerHTML = `<span>${educacionPorcentaje.toFixed(1)}% del total</span>`;
          summaryLaboralChange.innerHTML = `<span>${laboralPorcentaje.toFixed(1)}% del total</span>`;
        }

        // Actualizar gráficos
        function actualizarGraficos() {
          if (!currentData.length) return;
          
          const distribuciones = calcularDistribuciones(currentData);
          renderDemographicsCharts(distribuciones);
          
          // Renderizar gráficos específicos si la pestaña está activa
          if (document.querySelector('.tab[data-tab="sociocultural"]').classList.contains('active')) {
            renderSocioculturalCharts();
          } else if (document.querySelector('.tab[data-tab="afectivos"]').classList.contains('active')) {
            renderAfectivosCharts();
          } else if (document.querySelector('.tab[data-tab="cognitivos"]').classList.contains('active')) {
            renderCognitivosCharts();
          } else if (document.querySelector('.tab[data-tab="ambiental"]').classList.contains('active')) {
            renderAmbientalCharts();
          } else if (document.querySelector('.tab[data-tab="economica"]').classList.contains('active')) {
            renderEconomicaCharts();
          } else if (document.querySelector('.tab[data-tab="comunitario"]').classList.contains('active')) {
            renderComunitarioCharts();
          }
        }

        // Acción principal: obtener datos, procesar y renderizar
        async function actualizar() {
          try {
            // Obtener datos del período actual
            currentData = await obtenerFiltrados();
            
            // Procesar datos
            const distribuciones = calcularDistribuciones(currentData);
            const distribucionesLikert = calcularDistribucionesLikert(currentData);
            
            // Renderizar
            renderDemographicsCharts(distribuciones);
            llenarTablasResumen(distribuciones, distribucionesLikert);
            actualizarResumenes(distribuciones);
            
            // Renderizar gráficos específicos si la pestaña está activa
            if (document.querySelector('.tab[data-tab="sociocultural"]').classList.contains('active')) {
              renderSocioculturalCharts();
            } else if (document.querySelector('.tab[data-tab="afectivos"]').classList.contains('active')) {
              renderAfectivosCharts();
            } else if (document.querySelector('.tab[data-tab="cognitivos"]').classList.contains('active')) {
              renderCognitivosCharts();
            } else if (document.querySelector('.tab[data-tab="ambiental"]').classList.contains('active')) {
              renderAmbientalCharts();
            } else if (document.querySelector('.tab[data-tab="economica"]').classList.contains('active')) {
              renderEconomicaCharts();
            } else if (document.querySelector('.tab[data-tab="comunitario"]').classList.contains('active')) {
              renderComunitarioCharts();
            }
          } catch (err) {
            console.error(err);
            alert('Error al actualizar. Revisa la consola para más detalles.');
          }
        }

        // Inicialización
        await initApp();

      })();
    }
  </script>
</body>
</html>
